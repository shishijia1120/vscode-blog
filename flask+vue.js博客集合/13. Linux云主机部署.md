# Linux云主机部署
- 部署后端
配置环境：MySQL、Python3
1. MySQL


## 1. 部署后端Flask API
使用虚拟机安装Linux环境
http://www.madmalls.com/blog/post/customize-centos-7-3-autoinstall-iso/
### 1.1 MySQL
1. 安装
   安装MySQL社区版：
```
[root@CentOS ~]# wget http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm
[root@CentOS ~]# sudo rpm -ivh mysql-community-release-el7-5.noarch.rpm
[root@CentOS ~]# yum install -y mysql-server
[root@CentOS ~]# systemctl start mysqld
[root@CentOS ~]# systemctl enable mysqld
```
2. 安全加固
   启动 mysqld 服务后，我们还需要对服务器的安全性做一次强化，运行 mysql_secure_installation 命令时，它会提示你设置 root 用户的密码（默认初始时是空密码）、删除 anonymous 用户、删除 test 数据库、不允许 root 用户远程访问等

3. 创建Flask应用需要的数据库
   
### 1.2 Redis
我们后端应用会使用 RQ 任务队列，它需要 Redis：
```
[root@CentOS ~]# yum install -y epel-release
[root@CentOS ~]# yum install -y redis
[root@CentOS ~]# systemctl start redis
[root@CentOS ~]# systemctl enable redis
```
### 1.3 Elasticsearch
1. 安装
我们后端应用会提供全文检索功能，需要 Elasticsearch 7.0：
```
# 0. Need Java 8++
[root@CentOS ~]# yum -y install java-1.8.0-openjdk

# 1. Download and install the public signing key
[root@CentOS ~]# rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch

# 2. Create yum repository
[root@CentOS ~]# vim /etc/yum.repos.d/elasticsearch.repo
内容如下：

[elasticsearch-7.x]
name=Elasticsearch repository for 7.x packages
baseurl=https://artifacts.elastic.co/packages/7.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=1
autorefresh=1
type=rpm-md

# 3. Install Elasticsearch
[root@CentOS ~]# yum -y install elasticsearch
[root@CentOS ~]# systemctl start elasticsearch.service
[root@CentOS ~]# systemctl enable elasticsearch.service
```
2. 安装中文分词ik
由于博文基本上是中文字符，使用 Elasticsearch 默认的词法分析器效果不好，所以需要安装 elasticsearch-analysis-ik

首先确认你的 Elasticsearch 版本号是多少，我们刚安装的是 Elasticsearch-7.0.0，所以到 https://github.com/medcl/elasticsearch-analysis-ik/releases 这个页面下载对应的 ik 版本（elasticsearch-analysis-ik-7.0.0.zip）
```
[root@CentOS ~]# /usr/share/elasticsearch/bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.0.0/elasticsearch-analysis-ik-7.0.0.zip

[root@CentOS ~]# ls /usr/share/elasticsearch/plugins
analysis-ik
[root@CentOS ~]# /usr/share/elasticsearch/bin/elasticsearch-plugin list
analysis-ik
```
需要重启 Elasticsearch 服务！

3. 调整 Elasticsearch JVM参数
Elasticsearch 默认会使用 1G 内存，所以你的服务器内存至少需要 2GB，如果内存不足的话，可以限制 Elasticsearch 使用的内存量，比如只让它使用 256MB：
```
[root@CentOS ~]# vim /etc/elasticsearch/jvm.options
修改：
# Xms represents the initial size of total heap space
# Xmx represents the maximum size of total heap space

-Xms256m
-Xmx256m
```
### 1.4 Python3
```
1. 准备编译环境
[root@CentOS ~]# yum -y install gcc make readline-devel sqlite-devel openssl openssl-devel libffi-devel zlib*

2. 编译安装
[root@CentOS ~]# wget -P /root http://python.org/ftp/python/3.6.4/Python-3.6.4.tar.xz
[root@CentOS ~]# tar xf Python-3.6.4.tar.xz
[root@CentOS ~]# cd Python-3.6.4/
[root@CentOS ~]# ./configure --prefix=/usr/local/python-3.6
[root@CentOS ~]# make && make install
[root@CentOS ~]# ln -s /usr/local/python-3.6/bin/python3.6 /usr/bin/python3
[root@CentOS ~]# ln -s /usr/local/python-3.6/bin/pip3.6 /usr/bin/pip3
```
更改 pip 安装源为国内的源（比如 aliyun）：
```
[root@CentOS ~]# mkdir ~/.pip
[root@CentOS ~]# vi ~/.pip/pip.conf

添加内容如下：
[global]
index-url = http://mirrors.aliyun.com/pypi/simple/

[install]
trusted-host=mirrors.aliyun.com
```
### 1.5 尝试启动Flask应用
你可以使用 git 或 xftp 将后端代码 back-end 整个目录上传到服务器上，比如放在 /home/www/back-end 位置

复制 /home/www/back-end/.env.example，并重命名为 /home/www/back-end/.env，然后修改里面的配置：

FLASK_DEBUG： 设置为 0，正式环境中不需要开启 Debug
SECRET_KEY： 你可以使用 python3 -c "import uuid; print(uuid.uuid4().hex)" 命令生成随机数，并赋值给 SECRET_KEY 环境变量即可
DATABASE_URL： 需要设置数据库连接为 MySQL 连接字符串，比如 mysql+pymysql://testuser:password@localhost:3306/madblog
MAIL_SERVER： 具体参考 http://www.madmalls.com/blog/post/email-support/#12-qq
修改 /home/www/back-end/config.py 中的 ADMINS 为你的邮箱地址，因为这个列表中的邮箱地址，在注册时，会自动赋予管理员的角色


最后执行如下命令：
```
[root@CentOS ~]# cd /home/www/back-end
[root@CentOS back-end]# python -m venv venv3
[root@CentOS back-end]# source venv3/bin/activate
(venv3) [root@CentOS back-end]# pip install -r requirements.txt
(venv3) [root@CentOS back-end]# pip install pymysql
(venv3) [root@CentOS back-end]# flask db upgrade
(venv3) [root@CentOS back-end]# flask deploy
(venv3) [root@CentOS back-end]# flask run -h 0.0.0.0 -p 5000
```

然后在你的笔记本中，打开浏览器，访问 http://192.168.40.122:5000/api/ping，如果返回 "Pong!" 则说明正常，先停止应用

### 1.6 Gunicorn
此时，可以切换到 Gunicorn 来启动 Flask 应用了：
```
(venv3) [root@CentOS back-end]# pip install gunicorn
```
使用 gunicorn 命令行来启动 Flask 非常简单：
```
(venv3) [root@CentOS back-end]# gunicorn -w 3 madblog:app -b 0.0.0.0:5000
[2019-04-21 07:23:53 +0800] [25375] [INFO] Starting gunicorn 19.9.0
[2019-04-21 07:23:53 +0800] [25375] [INFO] Listening at: http://0.0.0.0:5000 (25375)
[2019-04-21 07:23:53 +0800] [25375] [INFO] Using worker: sync
[2019-04-21 07:23:53 +0800] [25378] [INFO] Booting worker with pid: 25378
[2019-04-21 07:23:53 +0800] [25379] [INFO] Booting worker with pid: 25379
[2019-04-21 07:23:53 +0800] [25380] [INFO] Booting worker with pid: 25380
```

>说明：
>-w 3： 表示将启动 3 个 Gunicorn 进程，建议是 CPU 核数 * 2 + 1
>madblog:app： 表示将要启动的应用为，当前目录下的 madblog.py 模块中的 app 对象

如果你还能正常访问 Flask API，则先关闭应用，接下来我们将通过指定 gunicorn 配置文件来启动 Flask：
```
(venv3) [root@CentOS back-end]# mkdir deploy
(venv3) [root@CentOS back-end]# vim deploy/gunicorn.conf.py
内容如下:

import multiprocessing

bind = '0.0.0.0:5000'
workers = multiprocessing.cpu_count() * 2 + 1
# daemon = True
pidfile = '/run/gunicorn.pid'
loglevel = 'info'
errorlog = '/tmp/gunicorn-error.log'
accesslog = '/tmp/gunicorn-access.log'
access_log_format = '%(h)s %(l)s %(u)s %(t)s "%(r)s" %(s)s %(b)s "%(f)s" "%(a)s"'
```

那么，你现在可以通过如下命令来启动 Flask：
```
(venv3) [root@CentOS back-end]# gunicorn madblog:app -c deploy/gunicorn.conf.py
```
### 1.7 Supervisor
现在你想把用 Gunicorn 启动 Flask 应用的命令，放到 CentOS 后台执行，除了做成 Systemd 服务（请参考： http://www.madmalls.com/blog/post/systemd-tutorial/ ）以外，还可以使用 Supervisor

```
[root@CentOS ~]# yum install -y supervisor
[root@CentOS ~]# systemctl start supervisord.service
[root@CentOS ~]# systemctl enable supervisord.service
```
然后再提供相关配置文件即可，请参考： http://docs.gunicorn.org/en/stable/deploy.html#supervisor
```
[root@CentOS ~]# vim  /etc/supervisord.d/gunicorn.ini
内容如下:

[program:gunicorn]
command=/home/www/back-end/venv3/bin/gunicorn madblog:app -c deploy/gunicorn.conf.py
directory=/home/www/back-end
user=root
autostart=true
autorestart=true
redirect_stderr=true
```
>说明：
>command： 即启动 gunicorn 的命令，此处要写 绝对路径
>directory： 项目部署目录，不然没办法知道 command 中 madblog.py 模块在哪
有了配置文件，就可以通过 Supervisor 来管理 Gunicorn 了：
```
1. 增加配置文件后，需要更新
[root@CentOS ~]# supervisorctl reread
[root@CentOS ~]# supervisorctl update

2. 查看状态
[root@CentOS ~]# supervisorctl status

3. 启动/停止
[root@CentOS ~]# supervisorctl start gunicorn
[root@CentOS ~]# supervisorctl stop gunicorn
[root@CentOS ~]# supervisorctl restart gunicorn
```


## 2. 部署前端
### 2.1 npm run build
在自己的笔记本上，要先修改front-end/src/http.js，指定后端API的地址为你