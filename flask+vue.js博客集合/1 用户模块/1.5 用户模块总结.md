
## 1. token认证
### 1.1 基本token认证（不使用jwt）
用户模块的第一个重点是token认证。
在未添加邮件支持时，基本的token认证：
为了简化使用token认证时客户端与服务器端之间的交互，可以使用Flask-HTTPAuth插件。
当客户端想要开始与API交互时，它需要使用用户名和密码进行Basic Auth验证，然后获得
一个人临时token。只要token有效，客户端就可以发送附带token的API请求以通过认证。
一旦token到期，需要申请新的token。

**在User数据模型添加token**
```python
class User(PaginatedAPIMixin, db.Model):
    ...
    token = db.Column(db.String(32), index=True, unique=True)
    token_expiration = db.Column(db.DateTime)
    ...

    def get_token(self, expires_in=3600):
        now = datetime.utcnow()
        if self.token and self.token_expiration > now + timedelta(seconds=60):
            return self.token
        self.token = base64.b64encode(os.urandom(24)).decode('utf-8')
        self.token_expiration = now + timedelta(seconds=expires_in)
        db.session.add(self)
        return self.token

    def revoke_token(self):
        self.token_expiration = datetime.utcnow() - timedelta(seconds=1)

    @staticmethod
    def check_token(token):
        user = User.query.filter_by(token=token).first()
        if user is None or user.token_expiration < datetime.utcnow():
            return None
        return user
```
**HTTP Basic Authentication**
```python
from flask import g
from flask_httpauth import HTTPBasicAuth
from app.models import User
from app.api.errors import error_response

basic_auth = HTTPBasicAuth()


@basic_auth.verify_password
def verify_password(username, password):
    '''用于检查用户提供的用户名和密码'''
    user = User.query.filter_by(username=username).first()
    if user is None:
        return False
    g.current_user = user
    return user.check_password(password)


@basic_auth.error_handler
def basic_auth_error():
    '''用于在认证失败的情况下返回错误响应'''
    return error_response(401)
```

**客户端申请Token**
```python
from flask import jsonify, g
from app import db
from app.api import bp
from app.api.auth import basic_auth


@bp.route('/tokens', methods=['POST'])
@basic_auth.login_required
def get_token():
    token = g.current_user.get_token()
    db.session.commit()
    return jsonify({'token': token})
```
装饰器 @basic_auth.login_required 将指示 Flask-HTTPAuth 验证身份，当通过 Basic Auth 验证后，才使用用户模型的 get_token() 方法来生成 token，数据库提交在生成 token 后发出，以确保 token 及其到期时间被写回到数据库

**小结**
用户注册成功后，登录输入用户名、密码后，客户端调用/tokens，首先装饰器 @basic_auth.login_required 将指示 Flask-HTTPAuth 验证身份（其中验证身份成功后，g.current_user=user）。当通过后调用g.current_user.get_token()(将token/token_expires添加到数据库)再提交数据库会话