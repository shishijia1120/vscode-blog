# 后台管理
>我们需要一个后台来管理所有已注册的用户列表、他们所发布的博客文章和评论等，为了节约时间，我只是在前端菜单栏上增加了 Admin 入口，简单的演示如何管理角色、用户、博客、评论等，并没有重新开发另一个完整的后台管理系统

## 1. Admin
### 1.1 导航栏入口
首先需要在导航栏中增加 Admin 管理后台的入口，并且结合上一章 权限管理，只有管理员才能看到这个入口

修改 front-end/src/components/Base/Navbar.vue：
```javascript
<ul class="navbar-nav mr-auto mt-2 mt-lg-0">
  <li class="nav-item active">
    <router-link to="/" class="nav-link">Home <span class="sr-only">(current)</span></router-link>
  </li>
  <li class="nav-item">
    <router-link to="/ping" class="nav-link">Ping</router-link>
  </li>
  <li class="nav-item" v-if="sharedState.is_authenticated && sharedState.user_perms.includes('admin')">
    <router-link to="/admin" class="nav-link">Admin</router-link>
  </li>
</ul>
```

### 1.2 相关组件


### 1.3 前端路由
最后，增加前端路由，修改 front-end/src/router/index.js：
```javascript
...
// 管理后台
import Admin from '@/components/Admin/Admin.vue'
import AdminRoles from '@/components/Admin/Roles.vue'
import AdminUsers from '@/components/Admin/Users.vue'
import AdminPosts from '@/components/Admin/Posts.vue'
import AdminComments from '@/components/Admin/Comments.vue'
...

const router = new Router({
  // mode: 'history',
  scrollBehavior,  // 不用这个，在需要跳转的改用 vue-scrollto
  routes: [
    {
      path: '/',
      name: 'Home',
      component: Home
    },
    ...
    {
      // 管理后台
      path: '/admin',
      component: Admin,
      children: [
        { path: '', component: AdminRoles },
        { path: 'roles', name: 'AdminRoles', component: AdminRoles },
        { path: 'users', name: 'AdminUsers', component: AdminUsers },
        { path: 'posts', name: 'AdminPosts', component: AdminPosts },
        { path: 'comments', name: 'AdminComments', component: AdminComments }
      ],
      meta: {
        requiresAuth: true,
        requiresAdmin: true
      }
    },
    {
      path: '/ping',
      name: 'Ping',
      component: Ping
    }
  ]
})

router.beforeEach((to, from, next) => {
  const token = window.localStorage.getItem('madblog-token')
  if (token) {
    var payload = JSON.parse(atob(token.split('.')[1]))

    var user_perms = payload.permissions.split(",")
  }

  if (to.matched.some(record => record.meta.requiresAuth) && (!token || token === null)) {
    // 1. 用户未登录，但想访问需要认证的相关路由时，跳转到 登录 页
    Vue.toasted.show('Please log in to access this page.', { icon: 'fingerprint' })
    next({
      path: '/login',
      query: { redirect: to.fullPath }
    })
  } else if (token && !payload.confirmed && to.name != 'Unconfirmed') {
    // 2. 用户刚注册，但是还没确认邮箱地址时，全部跳转到 认证提示 页面
    Vue.toasted.show('Please confirm your accout to access this page.', { icon: 'fingerprint' })
    next({
      path: '/unconfirmed',
      query: { redirect: to.fullPath }
    })
  } else if (token && payload.confirmed && to.name == 'Unconfirmed') {
    // 3. 用户账户已确认，但又去访问 认证提示 页面时不让他过去
    next({
      path: '/'
    })
  } else if (token && (to.name == 'Login' || to.name == 'Register' || to.name == 'ResetPasswordRequest' || to.name == 'ResetPassword')) {
    // 4. 用户已登录，但又去访问 登录/注册/请求重置密码/重置密码 页面时不让他过去
    next({
      path: from.fullPath
    })
  } else if (to.matched.some(record => record.meta.requiresAdmin) && token && !user_perms.includes('admin')) {
    // 5. 普通用户想在浏览器地址中直接访问 /admin ，提示他没有权限，并跳转到首页
    Vue.toasted.error('403: Forbidden', { icon: 'fingerprint' })
    next({
      path: '/'
    })
  } else if (to.matched.length === 0) {
    // 6. 要前往的路由不存在时
    Vue.toasted.error('404: Not Found', { icon: 'fingerprint' })
    if (from.name) {
      next({
        name: from.name
      })
    } else {
      next({
        path: '/'
      })
    }
  } else {
    // 7. 正常路由出口
    next()
  }
})

export default router
```


## 2. 角色管理
>角色管理功能分析：1. 显示角色列表 2.添加角色 3. 编辑角色 4. 删除角色


### 2.1 角色对象转换成JSON
```python
class Role(PaginatedAPIMixin, db.Model):
    ...
    def to_dict(self):
        data = {
            'id': self.id,
            'slug': self.slug,
            'name': self.name,
            'default': self.default,
            'permissions': self.permissions,
            '_links': {
                'self': url_for('api.get_role', id=self.id)
            }
        }
        return data

    def from_dict(self, data):
        for field in ['slug', 'name', 'permissions']:
            if field in data:
                setattr(self, field, data[field])
```
### 2.2 角色列表
```python
@bp.route('/roles', methods=['GET'])
@token_auth.login_required
@admin_required
def get_roles():
    '''返回所有的角色的集合'''
    page = request.args.get('page', 1, type=int)
    per_page = min(request.args.get('per_page', 10, type=int), 100)
    data = Role.to_collection_dict(Role.query, page, per_page, 'api.get_roles')
    return jsonify(data)
```
修改 front-end/src/components/Admin/Roles.vue：
```javascript
```

### 2.3 添加角色

(1)后端API
1. /roles/perms 
   def get_perms():#获取所有Permissions
2. /roles 
   def create_role():#注册一个新角色

(2)添加角色的表单
两个重要方法 methods：
1. getPerms()：获取所有Permissions,形如[{'name':'FOLLOW','dec':1},...]

2. onSubmit(e)：添加角色
  
主要前端数据data()：
1. roleForm:{}
2. perms:null（后台返回的所有权限列表json格式） 3. checkPerms:[](添加角色时管理员勾选中的权限列表)

### 2.4 修改角色
（1）后端API
1. /roles/<int:id>
   def get_role(id):#返回一个角色
      注意：data=role.to_dict(),而data需要一个权限列表，为当前角色已拥有的操作权限列表（整数列表）

2. /roles/<int:id>
   def update_role(id)
   
(2) 添加修改角色的表单
主要前端数据：
1. roleForm:{slug:'',name:'',permissions:[],errors:0,slugError:null,nameError:null}
2. perms:null
3. checkPerms:[]

methods方法：
1. getPerms()
2. getRole()
3. onSubmit(e)