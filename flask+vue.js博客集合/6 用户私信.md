# 用户私信
## 1. 数据模型
修改 back-end/app/models.py，增加 Message 数据模型：
```python
class User(PaginatedAPIMixin, db.Model):
    ...
    # 用户发送的私信
    messages_sent = db.relationship('Message', foreign_keys='Message.sender_id',
                                    backref='sender', lazy='dynamic',
                                    cascade='all, delete-orphan')
    # 用户接收的私信
    messages_received = db.relationship('Message',
                                        foreign_keys='Message.recipient_id',
                                        backref='recipient', lazy='dynamic',
                                        cascade='all, delete-orphan')
    # 用户最后一次查看私信的时间
    last_messages_read_time = db.Column(db.DateTime)
    ...

    def new_recived_messages(self):
        '''用户未读的私信计数'''
        last_read_time = self.last_messages_read_time or datetime(1900, 1, 1)
        return Message.query.filter_by(recipient=self).filter(
            Message.timestamp > last_read_time).count()


class Message(PaginatedAPIMixin, db.Model):
    __tablename__ = 'messages'
    id = db.Column(db.Integer, primary_key=True)
    body = db.Column(db.Text)
    timestamp = db.Column(db.DateTime, index=True, default=datetime.utcnow)
    sender_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    recipient_id = db.Column(db.Integer, db.ForeignKey('users.id'))

    def __repr__(self):
        return '<Message {}>'.format(self.id)

    def to_dict(self):
        data = {
            'id': self.id,
            'body': self.body,
            'timestamp': self.timestamp,
            'sender': self.sender.to_dict(),
            'recipient': self.recipient.to_dict(),
            '_links': {
                'self': url_for('api.get_message', id=self.id),
                'sender_url': url_for('api.get_user', id=self.sender_id),
                'recipient_url': url_for('api.get_user', id=self.recipient_id)
            }
        }
        return data

    def from_dict(self, data):
        for field in ['body', 'timestamp']:
            if field in data:
                setattr(self, field, data[field])
```
## 2. RESTful API设计
创建messages.py：
|HTTP方法|资源URL|说明|
|----|----|----|
|POST|/messages/|给其它用户发送私信|
|GET|/messages/|返回私信集合，分页|
|GET|/messages/<int:id>|返回单个私信|
|PUT|/messages/<int:id>|修改单个私信|
|DELETE|/messages/<int:id>|删除单个私信|

然后，修改 app/api/__init__.py 导入 messages.py：

## 3. 新私信通知
修改 back-end/app/models.py
```python
class User(PaginatedAPIMixin, db.Model):
    ...
    def new_recived_messages(self):
        '''用户未读的私信计数'''
        last_read_time = self.last_messages_read_time or datetime(1900, 1, 1)
        return Message.query.filter_by(recipient=self).filter(
            Message.timestamp > last_read_time).count()
```

同时，修改添加私信和删除私信的 API：

### 3.1 给别人发私信
已登录的用户在查看其它人的个人主页时，会显示 Send private message 按钮，修改 User.vue 组件：

发送完成后，可以通过链接返回到 已发私信列表 页面，查看你给哪些用户发过私信。这里没有像博客文章资源一样依次列出每条私信，而是列出对方用户，显示你给对方发送过几条私信，她还有几条未读

要实现上面的效果，后端需要增加 API，修改 back-end/app/api/users.py：



|HTTP方法|资源URL|说明|
|----|----|----|
