### 10 网络管理
越来越多的企业都在使用Linux系统，甚至将其作为自己主要服务器的操作系统。这得益于Linux系统中有许多可以免费获得和使用的服务软件，例如域名服务、FTP、HTTP等，这些网络服务都依赖于Linux系统的网络功能，因此网络管理员十分重要。


#### 10.1 网络接口配置命令

如果计算机要与外部通信，就必须使用网络接口，网络接口是目前计算机中最主要的网络连接设备。默认情况下，一个网络接口卡对应一个网络连接。如果需要将计算机与网络相联，除非使用了DHCP服务器(DHCP服务器能自动为网络中的计算机分配IP地址、子网掩码等信息)，否则需要手动配置网络接口。

##### 10.1.1 查看网络接口信息

1. ifconfig命令

查看系统中所有可用的网络接口信息，可以使用命令ifconfig。命令中的if是interface的缩写，其中文含义是接口。注意区分该命令与Windows系统中的ipconfig命令(该命令用于查看网络连接的IP地址等信息)。

**命令格式**
ifconfig命令既可以查看网络接口信息，也可以配置网络接口。

```ifconfig [option] [interface]```

**常用选项**
- a:显示系统中的所有接口，包括被禁用的接口。

(1) 如果不使用任何选项和参数，ifconfig命令将显示当前系统中的所有活动接口。
    ```# ifconfig```

(2) 如果系统中有网络接口被禁用，使用命令ifconfig将不会显示这些网络接口信息，可使用选项a显示所有网络接口信息
   ```# ifconfig -a```
(3) 查看指定的网络接口
    ```# ifconfig eth0```

2. 使用ip命令查看网络接口的IP地址
。。。。。。



##### 10.1.2 配置网络接口

除非使用了DHCP，否则只是网线与网卡连接是无法连接到网络的，还需要修改网络接口的配置，为其添加IP地址、子网掩码等，才能连接到网络。
1. 使用ifconfig命令配置网络接口
当系统中存在多个网络接口时，如果未正确配置IP地址等信息，通常是无法判断哪个网络接口连接到了哪个网络上的。另一种情况是向系统添加了新的网卡，系统启动后，网络接口的编号发生了变化(除非原来系统中的网卡配置文件中保存了网卡的MAC地址)，无法判断哪个网络接口对应哪个网络。
如果遇到了上面讲述的这两种情况，建议先使用ifconfig命令配置网络接口，并判断网络接口对应的网络，然后将配置写入配置文件。

**命令格式**
```ifconfig <intelface> <address>```
```netmask <netmask> [up | down]```
```ifconfig <intelface> <address>```
```</prefixlen> [up|down]```

使用ifconfig命令只能临时修改网络接口的设置，系统重新启动后，这些设置将会丢失。

**用法示例**

(1) 如果要设置的网络接口已经处于活动状态，可以直接使用ifconfig命令为其指定IP地址、子网掩码。

例如要设置网卡eth1的IP地址、子网掩码，IP地址：192.168.204.200，子网掩码为：255.255.255.0 ：
```# ifconfig eth1 192.168.204.200 ```
```netmask 255.255.255.0```

(2) 如果觉得上面的命令输入起来非常麻烦，可以使用比较简捷的方法：
```# ifconfig eth1  192.168.204.200/24```

(3) 如果网络接口处于非活动状态，可以使用up参数让配置立即生效，并使用新的配置信息启动网络连接：
```# ifconfig eth1 192.168.204.200 ```
```netmask 255.255.255.0 up```

上面的命令也可以写为如下形式：
```# ifconfig eth1  192.168.204.200/24 up```

使用ifconfig命令设置网络接口后，接下来就可以使用ping命令验证网络接口eth1对应的网络是否为192.168.204.0了

>注意：以长度方式表示子网掩码时，需要将子网掩码中的所有数字都转换成二进制数，使用二进制数1的位数表示子网掩码。由于十进制数255转换成二进制数为8个1，因此24位表示的子网掩码应该是255.255.255.0。


2. 保存设置到网络接口配置文件
网络接口的配置文件位于目录/etc/sysconfig/network-scripts/中，按网络接口的名称不同，文件名称为ifcfg-ethX，其中X为网络接口编号。除此之外，还有一个名为ifcfg-lo的文件，该文件是环回接口的配置文件。

查看网络接口eth1的配置文件如下：
```# cat /etc/sysconfig/network-scripts/ifcfg-eth1```

网络接口配置文件中的有效行都有一个固定的格式，即"配置项=配置项的值"。常见的配置项的具体含义和可选值如下。
- DEVICE:网络接口的名称，通常由系统自动生成，无须手动配置。此处的网络接口名称应该与配置文件名相对应。
- BOOTPROTO:表示此网络接口的配置方式，即开启该网络接口之后应该如何获取其设置。
- ONBOOT:系统启动时是否需要启动该连接。yes表示启动，no表示关闭。
- HWADDR:这是一个可选配置项，表示网络接口使用的MAC地址。某些系统会自动生成此配置项及其值。通常不需要修改该配置项的值。
- NETMASK:网络接口使用的子网掩码。
- IPADDR:网络接口使用的IP地址。
- GATEWAY:网络接口对应网络的默认网关。
- TYPE:该连接的类型，最常见的值为Ethernet，表示这是一个以太网接口。

上面的配置项中，HWADDR和TYPE都是由系统自动生成的，通常通常这两个选项都可以不必设置。

在上面列举的配置项中，有一个比较特殊的配置项BOOTPROTO，这个配置项可以使用的值及其含义如下。
- dhcp:这个值表示该连接启动时应该尝试从DHCP服务器获取此连接的初始配置信息。从DHCP服务器中获取的配置信息包括IP地址、子网掩码、默认网关及DNS服务器地址(DNS服务器用于解析域名和IP地址间的对应关系)等。
- static:表示该连接应该使用配置文件中的设置。使用此值时，需要在配置文件中设置静态的IP地址、默认网关(可选)、子网掩码。
- none:表示不使用DHCP获取连接初始化信息。该值可以用于接口使用静态IP地址时，也可以表示网络接口有其他用途，不需要使用IP地址等设置时(例如网络接口处于bonding中时)。

3. 使用工具设置网络接口




##### 10.1.3 重新启用网络接口

虽然已经通过修改配置文件、set工具集等方法保存了网络接口的设置，但这些设置并不会立即生效。这时需要手动重新启用相关网络接口，让系统读取新的配置文件，之后才能生效。要重新启用网络接口，可以使用两种方法实现：重新启动系统网络服务、重新启动指定的网络接口。

1. 重新启动网络服务
在RHEL5.3中，有一个名为network的系统服务。在这个服务的主要作用是初始化系统网络，为系统提供网络支持。系统启动时，network服务会检查系统中网络接口的情况，并启用这些连接。可以利用重新启动这个服务的方法重新启用网络接口。

(1) 重新启动网络服务：
```# service network stop 使用关闭、启动服务的方法重新启用网络接口```
```# service network start ```

(2) 如果系统不支持命令service，可以使用以下命令代替：
```/etc/init.d/network restart 使用绝对路径的方式重新启动网络服务 ```

2. 重新启动网络接口
要让系统重新读取已经设置好的网络接口配置文件，也可以使用重新启动网络接口的方法。
(1) 重新启用网络接口，也可以使用ifconfig命令。例如要重新启用网络接口eth1:
```# ifconfig eth1 down 使用ifconfig命令的down和up参数重新启用网络接口eth1```
```# ifconfig eth1 up```

(2)除ifconfig命令以外，还可以使用命令ifdown和ifup。这两个命令的功能分别是关闭和开启参数指定的网络接口。
例如要重新启动网络接口eth1:
```# ifdown eth1 使用ifdown和ifup命令重新启用网络接口```
```# ifup eth1```


##### 10.1.4 配置DNS服务器地址
DNS服务器地址这是每一个使用Internet的计算机都需要配置的内容。计算机只有通过DNS才能查找到域名对应的IP地址，因此在计算机网络中十分重要。


与网络接口的配置相同，也需要将DNS服务器地址保存在文件中，并且也可以使用修改文件和使用工具配置两种方法。

1. 域名服务器配置文件
在Linux系统中，域名服务器的配置文件是/etc/resolv.conf。默认情况下，域名配置文件中只保留了一个搜索路径。

(1) 查看这个文件的内容：
```# cat /etc/resolv.conf 使用cat命令查看域名服务器的配置文件```
```# 下面这个配置行表示在当前主机使用的域localdomain中搜索  search localdomain```

(2) 如果要添加DNS服务器地址，需要使用以下格式：
```# 添加DNS服务器地址的格式```
```其中IPaddress为DNS服务器的IP地址```
```nameserver IPaddress```

此处以两个私有域名服务器IP地址为例，修改文件resolv.conf的内容如下：
```查看修改后的域名服务器配置文件的内容```
```# cat /etc/resolv.conf```
```#使用 "#"注释文件原有的内容```
```# search localdomain```
```# 添加两个私有域名和服务器:192.168.111.200 和192.168.121.200```
```nameserver 192.168.111.200```
```nameserver 192.168.121.200```

(3) Linux系统并没有对添加的DNS服务器IP地址的个数作限制，但当设置的DNS服务IP地址超过3条时，通常只有前3条起作用。

2. 使用工具配置DNS服务器地址



#### 10.2 路由命令route

。。。。。。







#### 10.3 主机名称命令hostname
在Linux系统中，主机名称(有时也称主机名、计算机名)的全程一般分为两部分，第1部分用于标识主机，第2部分用于标识主机系统所在域。例如一个合法的主机名：web.example.com，可以看出，主机名称实际上就是一个域名。的确如此，早期主机名的作用就是快速访问网络中的计算机，但现在管理员主要用来分辨主机。
例如网络中有5台Web服务器，其计算机名分别为Web1至Web5。如果同时连接到这5个服务器，这时管理员通常通过主机名快速分辨当前正在输入命令的服务器。这是因为命令提示符会显示主机名称。
如果有多个主机需要管理，不妨使用上面的方法，以免在错误的主机中，错误地执行了管理命令(例如错误地执行力rm、mkfs等，这可能是致命的错误)。除此以外，主机名在某些服务中也有重要的用途(例如Samba服务器等)。

##### 10.3.1 查看主机名称
虽然命令提示符中显示了主机名称，但有时我们希望能看到当前主机名所在的域，这时可以直接使用命令hostname。
(1) 使用hostname命令时，不需要使用任何选项和参数:
```# hostname ```
```localhost.localdomain```

localhost表示当前主机的名称，localdomain表示当前系统所在的域。

(2) 主机名称通常存放在系统环境变量HOSTNAME中，因此也可以使用查看环境变量的方法查看主机名，注意变量名应该使用大写：
```# echo $HOSTNAME```
```localhost.localdomain```


##### 10.3.2 修改主机名称
修改主机名称有用命令修改和修改配置文件两种方法。使用命令修改主机名通常用于测试主机名是否可用。这种方法修改的主机名在系统重启后将丢失。
>除了这两种方法，还可以使用setup工具集的方法修改主机名。

1. 使用命令修改主机名
```[root@localhost ~]# hostname Web1.example.com```
```[root@localhost ~]# hostname```
```Web1.example.com```

此时如果重新登录，就会看到命令提示符变为：
```[root@Web1 ~]```

2. 使用配置文件修改主机名
。。。。。。


#### 10.4 设置网络冗余
。。。。。。










#### 10.5 网络工具
许多Linux系统都不是孤立地存在于某一个网络中，它总是会与其他服务器或网络产生"交流"。当这种交流出现故障时，初学者可能会感觉比较难处理。即使是有经验的管理员，面对大型网络中的小故障可能都会感到十分困难，原因在于有许多故障点需要花时间去逐一排查。
为了解决网络故障，Linux系统自带了许多用于排查各类故障的工具。利用这些工具，用户可以诊断网络的各个方面，排除网络故障。

##### 10.5.1 测试连通命令ping
ping命令主要功能是检查目标主机与本地主机之间的双向连通性。双向连通性是指目标主机与本地主机之间能够双向收发数据。


**命令格式**
```ping [option] ipaddress```
在上面的格式中，ipaddress可以是目标主机的IP地址、域名、主机名。如果使用域名、主机名作为目标主机地址，需要使用本地hosts文件DNS服务器解析。

**常用选项**
- c:指定发送数据包的个数。
- f:快速发送数据包，用于对当前主机与目标主机的网络执行极限测试
- s:指定发送的数据包大小，该选项主要用于测试链路质量和主机响应速度。
- I:指定发送测试数据包的网络接口。
- R:显示数据包经过的路由过程。
- t:指定数据包使用的TTL值(TTL用于控制数据包的生命周期)。

**用法示例**

。。。。。。

(1) 例如测试与默认网关之间的连通性：
```# ping 192.168.204.1```

。。。。。。
(2) 有时可能要对网络连接做丢包率评估，需要指定要测试的数据包个数，这时可以配合使用选项c。

例如要发送3个数据包测试与网关之间的通信情况：
```# ping -c  3 192.168.204.1 ```
使用上面的示例命令时，不需要使用快捷键中止，ping命令只发送了3个数据就输出了统计信息。

(3)  有时需要对目标主机之间的通信进行极限测试，极短时间内大量数据包的传输测试，可以配合使用选项f。
例如对网关进行极限测试：
```# ping -f 192.168.204.1 ```
这个命令的输出与前面不一样，由于会在短时间内发送大量的数据包(大约每秒钟发送的数据在1000~2000之间)，因此没有返回每个数据包的详情，而是使用点号"."表示丢丢失了一个数据包。

(4) 使用选项c指定发送数据包的个数
```# ping -f -c 2000 192.168.204.1 ```

(5) 使用选项s指定发送的数据包大小，默认大小为64字节。

例如要向网关发送大小为10000字节的测试数据包：
```# ping -s 10000 192.168.204.1 ```

(6) 使用选项I指定ping命令使用的网络接口。
例如指定测试网络接口eth0与目标主机之间的连通性：
```# ping -I eth0 192.168.111.1 ```

(7) 使用选项R显示数据包经过的路径。
例如要测试与目标主机的连通性，并且显示数据包经过路径：
```# ping -R 192.168.111.10 ```

(8) 使用选项t指定TTL值，TTL值可以用于返回路由器的地址。
```# ping -t 4 61.138.2.69 ```


##### 10.5.2 网络路径测试命令traceroute
许多时候主机处于一个庞大的网络中，主机到目标主机的网络出现问题时(表现为ping命令返回超时)，要找出故障节点可能会非常复杂，并且也非常麻烦。虽然使用"ping"命令也可以找出故障节点，但有时效果并不理想，这时可以使用网络路径测试命令traceroute。
traceroute命令的功能与ping命令的功能相似，也是用于测试与目标主机之间的连通性。不同的是，traceroute命令会测试与目标主机间的路由器的连通性，即traceroute命令会测试通往目标主机间的所有节点的连通性，这样就可以很容易地找出本地系统主机与目标主机间的故障点，从而直接排查有问题的节点。

traceroute命令使用目标主机的IP地址作为参数，测试并返回本地主机到目标主机间所有经过的路由器连通情况及测试结果。使用时不必使用的任何选项。

例如要测试本地主机与目标主机间的所有路由器的连通情况：
```# traceroute 192.168.144.186 ```
命令输出了所有经过的路由器的IP地址(包括目标主机)及测试产生的结果。由于需要逐一测试，因此traceroute命令的执行速度比ping命令要慢很多。

事实上traceroute命令与ping命令的选项R工作原理相同，都是利用TTL值获取中间路由的IP地址。不同的是traceroute命令将测试中间路由的连通性。


##### 10.5.3 查看网络状态命令netstat

netstat命令通常用于查看系统中的网络连接状态，包括系统当前网络接口状态、路由表、系统中服务端口使用情况等。系统管理员们经常使用netstat命令查看系统中网络接口状态，以及系统与外部的连接情况，以便确认系统的安全性，例如是否有未授权的用户使用终端登录服务器等，

**命令格式**
```netstat [option]```

使用netstat命令还需要一些前提知识，主要是TCP、UDP连接等方面的基础知识。

**常用选项**
- i:查看网络接口的使用情况。
- t:列出正在使用的TCP连接。
- u:列出正在使用的UDP连接。
- a:查看所有正在连接中的套接字。
- n:以IP地址的形式显示(而非域名)。
- p:显示套接字对应的进程名及PID。
- I:只显示正处于监听状态的套接字。

**用法示例**
1. 许多
例如要查看系统中中网络接口的使用情况，用如下命令：
```# netstat -i 使用选项i查看网络接口的使用情况```
。。。。。。



##### 10.5.4 域名解析工具dig和nslookup
大部分情况下人们都会使用域名浏览网站，例如访问网易时用www.163.com。当我们在浏览器中输入以上域名时，主机会首先与DNS服务器联系，要求DNS服务器解析域名对应的IP，以便浏览器使用IP地址打开网站。
但有时这个解析过程会出现问题，管理员可能无法确认哪个过程发生了错误，这时就需要借助域名解析工具进行判断，本小节将简单介绍域名解析工具dig和nslookup。
域名能被DNS服务器解析必须有两个前提条件，首先是本地hosts文件正确无误。如果hosts文件中的记录将要访问的域名指向不存在的地址，那么就算DNS服务器能正常解析，也不能起作用。其原因是系统查询域名时，总是先查询本地hosts文件，因此必须保证这个文件正确。其次是本地系统与DNS服务器之间必须能够进行双向通信，即使用ping命令测试能够返回结果。
如果确认系统能与DNS服务器进行双向通信，就需要借助域名解析工具判断当前使用的DNS服务器是否能正确解析域名。在Linux系统中，可以使用的域名解析工具有dig和nslookup两个。

1. dig工具
(1) dig命令没有常用的选项，直接将要查询的域名作为其参数即可。例如：
```# dig www.baidu.com 使用dig工具查询域名www.baidu.com对应的IP地址，默认情况下dig命令将使用系统设定的DNS服务器解析```

(2) 许多时候可能不知道哪个DNS服务器可用，如果将每个DNS域名服务器IP地址都写入文件/etc/resolv.conf并一一测试，会浪费许多时间。这时可以指定dig命令使用的DNS服务器地址。

例如用指定域名服务器解析网易域名对应的IP地址：
```# dig @61.139.2.69 www.163.com 使用@从指定DNS服务器61.139.2.69处查询```

通过这种方式，管理员可以从众多的DNS服务器中筛选可用的域名服务器，并将其IP地址写入配置文件。

2. nslookup工具
与dig不同的是，nslookup命令显示非常简单，并且还使用了一个可交互式的环境供用户使用。

(1) nslookup工具也可以像dig命令那样，直接将要查询的域名作为参数。例如使用nslookup命令查询域名对应的IP地址：
```# nslookup www.baidu.com ```

(2) 如果需要更换域名服务器查询，就需要进入nslookup的交互模式，并使用server命令切换DNS服务器。

例如要切换DNS服务器并查询域名：
```# nslookup 进入交互模式```
```# 使用server命令切换到IP地址为61.139.2.69的DNS服务器```
```> server 61.139.2.69```
```Default server: 61.139.2.69```
```Address:61.139.2.69#53```
```# 切换DNS服务器后查询域名```
```> www.baidu.com```
```# 退出交互模式```
```> exit```

>注意：系统从DNS服务器解析域名时，使用的目标端口为53，因此设置防火墙时需要保持这个端口可用。