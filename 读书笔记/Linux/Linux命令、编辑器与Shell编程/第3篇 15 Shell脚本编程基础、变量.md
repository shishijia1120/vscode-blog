## 15 Shell脚本编程基础、变量
为实现某个任务，将许多命令组合后，写入一个可执行的文本文件的方法，称为Shell脚本编程。

### 15.1 Bash脚本编程基础

#### 15.1.1 Shell脚本概述



#### 15.1.2 Shell脚本的基本内容

使用vi编辑器在当前目录中新建一个名为Hello.sh脚本文件：
```# vi Hello.sh ```

使用cat查看Hello.sh的内容
```# cat Hello.sh```

**Shell脚本的基本格式**

1. 调用Shell
```#!/bin/bash 告诉系统应该使用何种Shell来执行这个脚本，此处是Bsah```
2. 脚本注释
。。。。。。
3. 脚本内容
。。。。。。

#### 15.1.3 脚本的运行方式
脚本的运行方式通常有3种：使用Bash命令、使用点号和设置脚本的执行权限。

1. 使用bash命令执行脚本

```# bash Hello.sh```

使用bash命令执行脚本时，系统会使用bash命令来解释并执行脚本中的每一行。

2. 使用点号"."执行脚本
许多时候可以使用点号来执行脚本文件，这种执行脚本的方式通常用于调用系统脚本文件。

```# . Hello.sh```

使用这种方式执行脚本文件时，系统会使用当前Shell解释执行脚本文件。因此如果当前Shell是Bash，也可以使用这种方式执行脚本。

3. 设置脚本为可执行
这种方式需要先为脚本文件添加可执行权限，然后就可以像应用程序那样执行脚本文件。
```# chmod u+x Hello.sh```
```# ls -l Hello.sh```
执行脚本文件Hello.sh
```./Hello.sh```

使用这种方式执行脚本文件时，如果脚本文件没有位于环境变量中的搜索路径，应该使用绝对路径或相对路径指定脚本文件的位置。

除了以上3种方式，还可以使用sh命令执行Bash脚本文件。

#### 15.1.4 接收用户输入

许多时候需要获取用户的输入，例如需要用户输入名称、脚本下一步执行的操作等。这时可以使用read命令，将用户的输入保存在变量中，然后再读取变量获取用户的输入。


```# cat example.sh```

```echo -n "Input your name:"```
```read NAME```
```echo "Hello, "$NAME". "```

运行脚本：
```# chmod u+x example.sh```
```# ./example.sh```

#### 15.1.5 向脚本传递参数

```# cat example.sh```

```echo "The first parameter: " $1 ```
```echo "The second parameter: " $2 ```
```echo "The third parameter: " $3 ```
```echo "The fourth parameter: " $4 ```

上面的脚本文件中，分别使用$1、$2、$3、$4捕获传递给脚本文件的第1、2、3、4个参数，并将其输出。

执行脚本文件：
```# chmod u+x example.sh```
```# 为执行的脚本文件传递4个参数：One Two There Four```
```# ./example.sh One Two There Four```

```The first parameter:One```
```The second parameter:Two```
```The third parameter:Three```
```The fourth parameter:Four```

### 15.2 Tcsh脚本编程


### 15.3 Shell中的变量
脚本编程过程中，必然会接触到Shell中的变量。可以将变量理解为一个能引用的容器，当需要使用容器中的内容时，直接引用容器即可。
Bash中的变量没有数据类型的区别。变量中的值都是以字符串的形式保存的，如果要进行数值计算，需要进行特殊转换。

Linux Shell下的变量按其使用目的可以分为3种类型。
- 环境变量：用于保存操作系统运行时使用的环境参数。
- 位置变量：Bash将传递给脚本的参数保存在位置变量中，以便于在脚本中引用这些参数。
- 预定义变量：由系统保留和维护的一组特殊的变量，这些变量通常用于保存程序运行状态等。
- 自定义变量：由用户自行定义的变量。可用于用户编写的脚本、多个命令间的值传递等。

上面的变量中，除了自定义变量外，其他变量都是由系统自动生成并维护的。如非必要，用户不要轻易改变由系统生成和维护的变量值。


#### 15.3.1 保存系统运行情况的环境变量

系统环境变量是用户登录系统时，由系统自动生成并设置的一组变量。所有的进程、脚本都可以引用这些变量，因此环境变量的值通常与系统息息相关。

使用set命令查看当前系统中的环境变量
```set```

1. 系统中常见的环境变量

(1) 家目录位置变量HOME
HOME变量用于保存当前登录用户的家目录位置，这个变量的值是由系统用户文件/etc/passwd中的用户家目录字段定义的。

查看用户的家目录：
```# echo $HOME```
```/root```

(2) 系统语言变量LANG
LANG变量用于保存系统当前使用的语言，如果要临时修改当前系统使用的语言，通常可以通过修改该变量的值来实现。查看当前系统使用的语言如下：
```# echo $LANG```
```en_US.UTF-8```

临时修改系统语言可以重新指定此变量的值：
```# LANG=zh_CN.UTF-8```

(3) 交互程序变量SHELL

SHELL变量用于保存用户当前使用的Shell，可以通过查看该变量值的方法，快速查看当前使用的Shell：
```# echo $SHELL```
```/bin/bash```

(4) 命令搜索路径变量PATH
PATH变量用于保存当前用户使用的命令搜索路径。

查看当前用户使用的命令搜索路径：
```# echo $PATH```


(5) 主提示符PS1
变量PS1保存了用户使用的主提示符，这个主提示符通常都使用了一个字符串表达式。查看当前用户使用的主提示符：
```# echo $PS1```
```[\u@\h \w]\$```


这个表达式的结果形如:[root@localhost ~]#。

- \u:当前使用系统的用户。
- \h:当前计算机名称。
- \w:当前工作路径。
- \d:当前系统的日期。
- \$:提示符，root用户是井号"#"，普通用户是美元符号"$"。
- \H:完整的计算机名称。
- \t:24小时制的时间格式。
- \v:当前Bash的版本。

例如修改当前用户的提示符：
```[root@localhost ~]# PS1= '[\d \H \t \v]\$ ' ```
```[Thu Nov 11 localhost.locakdomain 16:03:36 3.2]# ```

以上命令修改了当前用户的提示符，这个修改立即就生效了。

(6) 辅助提示符变量PS2
变量PS2保存了用户当前使用的辅助提示符，要理解辅助提示符的作用，可以查看下面这个例子：
```# 查看当前使用的辅助提示符```
```# echo $PS2```
```>```
```# 辅助提示符一般用于强制换行时，提示用户继续输入命令```
```# 下面的>就是辅助提示符```
```# echo \```
```> Hello```
```Hello```

修改辅助提示符：
```# PS2='<'```
```# \```
```&gt;```

用户可以在命令提示符中临时修改环境变量的值，也可以通过修改配置文件的方法，永久地改变用户的工作环境。


2. 只读环境变量
只读环境变量无法更改。

查看只读环境变量：
```# readonly```


3. 修改环境变量
在命令提示符中修改的环境变量将在用户重新登录、系统重启后消失。这时可以在配置文件中修改环境变量。

用户环境变量的定义工作主要是在以下文件中完成的。
- /etc/profile:全局用户配置文件。如果修改了此文件中的设置，修改的设置将会影响系统中的所有用户。
- ~/.bash_profile:用户个人配置文件。如果修改了此文件中的设置，修改的设置只会影响单个用户。
- /etc/bashrc:全局环境变量配置文件。此文件中定义了所有用户的环境变量。
- ~/.bashrc:个人环境变量的配置文件。此文件中定义了用户的环境变量。

由于全局用户配置文件和全局环境变量配置文件会影响所有用户，因此不推荐修改这两个文件。

此处以修改用户的主提示符为例，讲解修改用户环境变量的方法。修改用户个人配置文件.bash_profile，修改后的内容如下：
```# cat .bash_profile```
```# .bash_profile```

以下为新加入的内容：
```# modify PS1```
```PS1='\h:'```
```# 使用export将变量PS1转换为全局变量```
```export PS1```

用户重新登录，环境变量PS1就可以生效。


#### 15.3.2 传递参数的位置变量
为了方便获取传递给脚本的参数，Bash定义了9个位置变量，分别是$1、$2、$3...$9。脚本编写者在脚本中引用这9个变量，获取传递给脚本的参数。

位置变量在15.1节已经介绍过。

#### 15.3.3 系统预先定义的变量
系统预先定义的变量简称为预定义变量，是由系统预先定义的一组变量，这些变量通常用于保存与系统、命令等有关的信息。预先定义变量由系统自动生成、维护，用户无须修改其值。

常见的预定义变量及其含义如下:
- $0:保存当前进程或脚本的名称。
- $*:保存传递给脚本或进程的所有参数。
- $$:当前进程或脚本的PID号。
- $!:后台运行的最后一个进程的PID号。
- $?:用于返回上一条命令是否成功执行。如果成功执行，将返回数字0，否则返回非零数字(通常返回1)。
- $#:用于保存脚本的参数个数。



(1) 示例脚本:
```# cat example3.sh```

```echo "script name:"$0 ```
```echo "all parameters:"$*```
```# 输出脚本的PID```
```echo "PID is the script:"$$```
```#输出上一条命令的执行状态```
```echo "success of the previous command:"$?```

执行脚本：
```# ./example3.sh One Two Three```
```script name:./example3.sh```
```all parameters:One Two Three```
```PID is the script:10521```
```success of the previous command:0```

(2) 下面是一个预定义变量$!的示例：
将两个进程放入后台执行，并使用变量$!输出最后一个进程的PID
```# sleep 100 &```
```[1] 10542```
```# sleep 300 &```
```[2] 10543```
```# echo $!```
```10543```


#### 15.3.4 用户自定义变量
Bash中的变量没有数据类型。

**自定义变量的命名规则**
- 由于变量没有具体的数据类型，因此在定义变量时可以不必定义其类型，直接赋值即可使用。
- 在Shell中变量名称可以由大写字母、小写字母、下划线、数字等符号组成。
- 定义变量时，建议使用大写字母、下划线和数字组成变量名，以免引起不必要的误解。
- 变量对大小写敏感。


**变量的作用域**
- 除非使用了export命令，否则在脚本中定义的变量(包括函数中定义的变量)的作用域是整个脚本。
- 在命令提示符中定义的变量和使用export定义的变量都是全局变量。全局变量可以在当前用户的任何脚本、命令中引用。

如果用户需要在脚本中定义全局变量，必须使用export命令。

**用法示例**
(1) 定义变量并赋值
```# NAME=Jhon```

变量的值可以不必放入引号内，除非值中含有特殊字符。

(2) 如果用户需要经常使用一个变量，可以将这个变量定义为一个环境变量。
例如要使用变量保存备份目录：
```# BACKUP_DIR=/file/backup```
```# export BACKUP_DIR```

(3) 如果用户希望定义一个不能更改值的只读变量，可以先定义变量，然后使用readonly命令将变量转换为只读变量。
例如要定义一个变量PI:
```# PI=3.14```
```# readonly PI```
```# PI=3.1415```   
```-bash: PI:readonly variable```

(4) 使用变量时，无论是引用变量，还是变量间的运算，都应该使用变量引用符"$":
```# NAME=Jhon```
```# echo "Hello, $NAME." ```
```Hello,Jhon.```

使用变量运算的例子：
```# A=12```
```# B=12```

```expr $A+$B```
```24```
因为Bash中的变量默认都是字符串类型的，只有使用命令expr将其转换后才能运算。

(5) 猜数游戏示例脚本： 

```# cat example5.sh```

。。。。。。
(6) 清除变量
```# echo $NAME```
```Jhon```
```# unset NAME```
使用unset命令清除变量时，不必使用变量引用符。

>如果用户编写了数个脚本，并且需要使用许多变量，可以为这些变量编写单独的变量文件，或将变量设置为全局变量，需要使用时引用这些变量即可。这样既可以方便脚本的编写，又方便维护变量。

### 15.4 Shell中的数组

#### 15.4.1 数组的定义

**定义数据**
(1) 直接在定义时为所有的数组元素赋值：
```# ARRAY=(1 2 3 4 5)```

(2) 对数组中的每个元素进行赋值：
```# ARRAY[0]=1; ARRAY[4]=5;```

#### 15.4.2 数组的使用
(1) 引用数组中的某个元素：
```# echo ${ARRAY[2]}```
在Bash中需要将数组元素放入大括号"{}"内。其目的是为了避免Bash将数组名误解为一个变量。

(2) 如果不指定数组索引，将会显示数组中第1个元素的值：
```# echo $ARRAY```

(3) 输出所有元素
```# echo ${ARRAY[*]}```

(4) 指定查看的元素范围：
```# echo ${ARRAY[@]:2}```
查看下标大于等于2的所有元素的值。

(5) 获得数组的长度
```# echo ${#ARRAY[@]}```

(6) 示例脚本：
。。。。。。

#### 15.4.3 清除数组
(1) 清除数组ARRAY的第1个元素：
```# unset ARRAY[0]```

(2) 清除整个数组：
```# unset ARRAY```