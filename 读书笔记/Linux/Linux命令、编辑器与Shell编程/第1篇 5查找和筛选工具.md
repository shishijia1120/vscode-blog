### 5 查找和筛选工具
Linux管理员经常需要从众多的命令输出及文本文件中查找和筛选一些信息(例如日志)，以便于从中了解服务器的运行状况、系统当前状态等信息。
#### 5.1 查找文件工具find
有时可能需要找出一个不知道保存在上面什么位置的文件，也可能在维护系统的过程中要找出具有某一特征的文件(例如修改时间、文件长度等)。这时可以利用find搜索整个文件系统，甚至是网络文件系统上的文件和目录。

##### 5.1.1 find的基本格式
**命令格式**
```find [path] [expression]```
**常用选项**
- path:find查找路径。如果未指定，则默认为当前工作目录。
- expression:用于定义find查找的表达式，表达式通常由选项、测试和动作3类参数组成。

相关选项看书

##### 5.1.2 按文件名称查找
很多时候管理员会忘记某一个文件存放在什么位置。可以使用name参数进行查找，也可以使用文件名称通配符配合查找。

1. 想要在/etc目录下查找Samba服务的配置文件smb.conf：
    ```# find /etc -name "smb.conf" -print```
2. 想要查找/etc目录下所有的配置文件：
    ```# find /etc -name "*.conf" -print```
3. 在当前目录中查找名为message的文件：
    ```find -name "messages" -print 如果未指定查找的目录，find将在当前目录中查找```
4. 如果想要在/etc查找两个小写字母加一个数字，最后面是.d的文件，可以使用下面这条命令：
    ```# find /etc -name "[a-z][a-z][0-9].d" -printf```
5. 在一个很大的文件系统上进行查找时，可能会花费很长时间，通常建议使用操作符&将find命令放到后台执行：
    ```# find / -name "*.conf" -print &```

##### 5.1.3 按文件权限查找
使用perm参数可以按照文件的权限进行查找，使用此参数时，需要使用八进制表示权限。按权限查找文件通常用在多用户系统中，以便于发现可能导致泄密、不安全的内容等。

**绝对模式**：指使用八进制表示权限的方法。绝对模式使用数字4表示读权限，2表示写权限，1表示执行权限，使用多权限时只需将数值相加即可。使用使用3位数字表示多用户权限，从坐起分别表示文件属主、属组和其他用户权限。

1. 在整个文件系统上查找属主可以读、写，属组可以读、写，其他用户可以读的文件。
    ```# find / -perm 664 -print  在整个文件系统上查找权限664的文件```
2. 在当前目录的file子目录下查找其他用户可以读、写、执行的文件(这种情况应当引起重视)，此时应该在权限数值前加一个横杠-（表示使用包含模式）。
    ```# find ./file -perm -007 -print 在当前目录的file子目录中查找权限中包含其他用户可读、写、执行的文件```


##### 5.1.4 按文件类型查找
用type参数可以按类型查找文件。常见的文件类型有目录、字符设备和普通文件等。按文件类型进行查找适合于一些比较特殊的情况，例如要查找某个设而而不知道其具体的名称等。

1. 查找/dev下有哪些字符设备：
    ```find /dev -type c -print 查找/dev目录中的字符设备。其中c表示字符设备```

2. 查找目录/dev中的块设备文件：
    ```# find /dev -type b -print 查找目录/dev的块设备文件，其中b表示块设备文件```

3.  查找目录/etc/rc3.d中除了链接文件以外的文件(通常情况下这个目录下只会存放链接文件)：
    ```# find /etc/rc3.d ! -type l -print l表示链接文件，感叹号表示否定```


##### 5.1.5 按文件的时间戳记和大小查找
在管理和维护Linux系统的过程中，经常需要清理一些过期的日志和文件，清理这些文件的标准通常是文件的修改时间、访问时间、文件的大小等。而另一种情况是我们需要知道一定时间内被修改过的文件，以便对这些文件进行备份等。
这时可以使用find命令的mtime、atime和size参数按文件的时间戳记和文件的长度查找。


1. 按时间戳查找文件

- 希望在整个文件系统上查找修改时间在一周内的文件：
  ```find / -mtime -7 -print 使用-7指定修改时间在7天以内的文件```
- 查找用户根目录下修改时间在1天以前的文件：
  ```# find ~ -mtime +! -print 使用+！指定修改时间在1天以前的文件```
- 查找目录/data中访问时间在10天以内的文件：
  ```# find /data -atime -10 -print 使用atime -10 指定访问时间在10天以内的文件```

2. 按长度查找文件
使用size按文件大小查找时，可以像按时间戳记那样使用+n表示文件长度大于n的文件，-n表示文件长度小于n的文件。默认情况下文件长度的单位是块(一块等于512字节)，如果要以字节来计算文件长度，应该在数字后加上小写字母c。
- 在当前目录下查找文件长度大于10MB的文件
```# find . -size +10000000c -print 使用+10000000c表示文件长度大于10MB的文件```
- 要在当前目录下查找文件长度小于30块的文件：
    ```# find . -size -30 -print 使用-30表示文件长度小于30块(512*30=15KB)的文件```
 在按文件大小查找文件时，也可以使用KB 、MB、 GB等较大的单位标记文件的大小。

##### 5.1.6 按文件属主或属组查找
当管理员将一个用户或用户组从系统中删除时，可能需要将该用户或用户组的文件收集起来保存一段时间。这时可以使用find命令的user、nouser、group和nogroup这几个参数，查找指定用户、用户组的文件。

1. 要查找目录/home中属主为lilei的文件
    ```# find /home -user lilei -print 使用user参数查找属主为lilei的文件```
2. 在整个文件系统上查找没有有效属主(即用户名在系统用户名/etc/passwd中不存在)的文件：
    ```# find / -nouser -print 使用nouser参数查找没有有效属主的文件```
3. 查找目录/file中属组为admin的文件：
    ```# find /file -group admin -print 使用group参数查找属组为admin的文件```
4. 在整个文件系统中查找没有有效属组(即用户组名称在系统用户组文件/etc/group中不存在)的文件：
    ```# find / -nogroup -print 使用nogroup参数查找没有有效属组的文件```


##### 5.1.7 find工具的其他参数
在find命令中还存在一些其他参数，这些参数使用频率较低(例如忽略某个目录)，但有时使用这些参数查找文件却十分方便。
1. 忽略目录参数prune
    在查找文件的时候，可能不需要查找某个目录，或用户已经知道某个目录中不存在这个文件，这时就可以使用prune参数忽略这些目录。
    例如要从除了/etc以外的整个文件系统上查找以.conf结尾的文件：
    ```# find / -path "/etc" -prunc -o -name "*.conf" -print 使用path、prune和name参数指定在除了.etc以外的整个目录中查找以.conf结尾的配置文件，使用参数o将两个不同的参数连接起来。```

2. 忽略远程文件系统参数mount
    如果系统上挂载有远程文件系统，搜索远程文件系统不仅要耗费大量网络资源，还要花费大量时间。这时可以使用mount参数忽略挂载的远程文件系统。
    例如要在本地文件系统上查找一个名为file的文件：
    ```# find / -name "file" -mount -print```


##### 5.1.8 使用exec和ok处理查找到的文件
在Linux管理和维护中，大多数时候查找具有某一类特征的文件的目的是为了处理这些文件，通常的处理方式有删除、移动等，例如查找并删除一些旧的文件或过期的日志等，这时可以使用动作参数中的exec、ok，这两个参数都可以对查找到的文件执行Shell命令。不同的是，使用ok参数执行较危险的Shell命令(例如删除文件命令rm)时会提示用户。

利用find命令查找到文件后，就可以使用exec、ok参数对查找到的文件执行Shell命令。使用exec、ok参数执行Shell命令的格式如下：
```-exec [Shell命令] {} \; ```
```-ok [Shell命令] {} \; ```

1. 查找当前目录的backup_sys子目录中，修改时间距现在一周以前、以messages开头的文件，并用ls命令查看：
    ```# find ./backup_sys -name "message*" -mtime +7 -exec ls -l {} \; ```
2. 查找并删除两周以前的备份文件：
   ```# find ./backup_sys -name "messages*" -mtime +14 -exec rm {} \;```
3. 如果要在执行Shell命令时获得命令执行的提示，可以使用ok参数。例如删除两周以前的备份文件并在执行前获得提示：
    ```# find ./backup_sys -name "message*" -mtime +14 -ok rm {} \; ```


##### 5.1.9 使用xargs命令处理查找到的文件
利用exec和ok参数处理查找到的文件时，存在一些缺陷，这些缺陷如下。
- 系统对参数exec、ok传递给Shell命令的文件列表长度有一定的限制。当find命令查找到的文件数量很多时，会出现参数列表溢出错误。
- 参数对find命令找到的每一个文件发起一个相应的处理进程，当find命令查找到的文件数量很多时，可能会影响整个系统性能。

xargs命令的作用是构造一个参数列表并交给命令执行。与参数exec、ok相比，xargs不会一次获取并处理其中的一部分。处理完后再获取下一部分，直至结束。整个过程xargs都只发起一个处理进程，对系统性能的影响很小。

使用xargs命令分割参数列表时，需要借助于管道。
例如查找当前目录的backup_sys子目录中，修改时间距现在两周以前的所有文件并删除：
```# find ./backup_sys -name "message*" -mtime +14 -print | xargs rm```

这条命令首先使用find查找相应的文件，然后使用管道传递给xargs，xargs命令构造参数列表之后再传递给rm命令执行删除操作。

##### 5.1.10 find工具应用实例
1. 使用find查找需要备份的文件

看书

#### 5.2 查找文本工具grep
许多时候需要从一大堆的命令输出或文本文件内容中找出一两行关键的内容，例如从系统用户文件中查找某个用户。可以使用grep工具对内容进行筛选。
**grep**是global regular expression print(全局正则表达式打印)的缩写。

##### 5.2.1 grep的基本格式
**命令格式**
```grep [option] pattern [file]```

**常用选项**
- i：忽略大小写
- n将结果输出的同时，也输出改行的行号。
- l：从多个文件中查找时，只输出找到匹配内容的文件名称。
- h：从多个文件中查找时，只输出匹配的内容，不显示文件名称
- c：只输出匹配内容的总行数
- v:反转查找

grep工作时，总是以行为单位查找。首先将文本的第1行读入缓冲区并执行查找，如果找到匹配的字符串，则输出整行。否则就丢弃缓冲区内容并读入下一个文本行继续查找，直到文本结束。

##### 5.2.2 使用grep查找文本
引入一个示例文本文件students。
1. 查找关键字
使用grep命令查找时，需要提供一个关键字。最好是独一无二的。
    ```# grep "92" students 在students中查找包含92的行```
2. 显示行号
有时可能需要确定查找到的结果处于文本的什么位置，这时可以配合选项n在查找时输出行号。
    ``` # grep -n "92" students ```
3. 统计结果
统计文件中一共有多少名来自西藏的学生：
    ```# grep -c "Xizang" students 使用c选项统计查找到的总行数```
4. 大小写敏感
grep命令继承了Linux系统对大小写字母敏感的特性，因此如果要使grep在查询过程中不区分大小写，应该配合使用i选项。

5. 反转查找
有时需要进行反转查找，即显示那些不匹配字符串的行，此时可配合选项v。
    ``` # grep -vi "tangwei" students | grep -vi "lixia" 使用选项v反转查找不含有tangwei和lixia的行，为了满足两个条件，使用两次查找```
6. 多文件查找
有时需要从多个文件中查询一些相关联的内容，这时就要用到多文件查询。
例如管理员要从目录/etc的文件中查找有关root用户的内容：
    ```# grep -l "root" "/etc/*"```

7. 在命令输出和变量中查找
grep不仅可以从文件中查询字符串，还可以从字符串和字符串变量中查询：
```# echo "Welcome to Beijin" | grep "to Beijin" 使用grep在命令输出中查找```

##### 5.2.3 行首、行尾匹配查找
1. 行首匹配
   ```# grep '^28' students 使用行首匹配符显示所有行首字符串为28的内容```
2. 行尾匹配
    ```# grep -v '[0-7][0-9]$' students | grep -v '8[0-4]$ '```

##### 5.2.4 配合常用的正则表达式查找
1. 使用范围模式匹配

2. 次数匹配模式
   有时需要知道一个匹配模式出现的次数。
   \
   ```# grep 'c\{3,\}' file.txt 使用次数匹配模式查找字母c至少出现2次的行```
3. 处理特殊字符
在使用grep查找的过程中，可能会遇到一些特殊字符，可以使用反斜线"\"屏蔽掉这些特殊字符的含义。
\
例如要查看当前目录下所有以.txt结尾的文件：
    ```# ls -l | grep '\.txt$' 使用反斜线屏蔽掉点号的特殊含义``` 

##### 5.2.5 使用或、与多匹配模式查找
1. 或匹配模式
   使用参数E让grep命令将要匹配的字符串延伸为一个普通的表达式，此时可以使用竖线|表示或匹配模式，即只需要匹配两个字符串的任意一个即可。
   \
   例如查询来自河南和云南学生的详细情况：
    ```# grep -E "Henam|Yunnan" students```
2. 与匹配模式
   然而参数E并不支持匹配模式查询，此时可以使用多条件管道实现。例如要查询Lixia的学生有哪些来自Sichuan:
   ```# grep -i "Lixia" students | grep "Sichuan"```


##### 5.2.6 grep工具应用实例
1. 精简配置文件
2. 从系统管理命令输出中查找
例如从服务列表中筛选出蓝牙服务，以便于查看这个服务在不同运行级别中的启动状态：
    ```# chkconfig --list | grep bluetooth```


#### 5.3 流编辑器sed
#### 5.4 格式化文本数据抽取工具awk
#### 5.5 转换和删除重复命令tr
#### 5.6 合并和分割工具