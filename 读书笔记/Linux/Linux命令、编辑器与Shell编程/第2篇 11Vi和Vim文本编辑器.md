### 11 Vi和Vim文本编辑器


#### 11.1 文本编辑器概述
文本编辑器是对纯文本进行编辑操作的一类软件，Windows系统中的记事本就是一个文本编辑器。

##### 11.1.1 文本编辑器的发展及分类
文本编辑器按编辑范围或方式可以分为行编辑器和全屏幕编辑器：
- 行编辑器：sed、awk由行编辑器演化而来的工具
- 全屏幕编辑器：Vi、Vim、Emacs等

文本编辑器按运行界面不同，可以分为字符界面编辑器和图形界面编辑器。
- 字符界面编辑器：Vi、Vim、Emacs、Nano等
- 图形界面编辑器：Gedit、Kate

##### 11.1.2  Linux系统中的文本编辑器
1. Vi编辑器
Vi编辑器是许多UNIX、Linux系统都默认安装的文本编辑器，主要在字符界面中。其十分小巧，在某些特殊情况下，Vi编辑器可能是唯一能使用的文本编辑器，

2. Emacs编辑器
Emacs从严格意义上讲并不应该被称为一个文本编辑器，，而应该称其为一个系统。这是因为它不仅仅是一个文本编辑器，利用它还可以收发电子邮件、登录远程主机和玩游戏等。不仅如此，利用Emacs甚至还可以煮咖啡!

3. Vim编辑器
Vim是Vi编辑器的增强版，除了能完全兼容Vi编辑器之外，还添加了许多新的功能，例如对编写程序代码的支持等。

4. Nano编辑器
Nano是一个十分小巧、简单的文本编辑器，功能简单适合初学者。

#### 11.2 认识Vi和Vim编辑器

##### 11.2.1 启动Vim编辑器

**命令格式**
```vim [option] filename```

可以直接使用命令vim编辑器，也可以讲文件名作为其参数，启动编辑器直接编辑参数指定的文件。


##### 11.2.2 Vim编辑器帮助


1. 要使用Vim的帮助信息，可以在编辑器中输入以下命令：
    ```:help```

2. 在帮助界面中还使用了一些链接，这些链接将帮助文件放入两个竖线"|"中。
   如果要跳转到



##### 11.2.3 退出Vim编辑器
退出编辑器又分为3中情况：正常退出、保存退出及强制退出。
1. 正常退出的前提条件是：打开的文本文件在内容上没有被改动、新建的文本文件没有添加任何内容、修改的文本文件已经保存等。
    ```:q 正常退出vim编辑器```
2. 如果退出时需要将已经编辑过的文本保存到文件中，可以使用以下命令保存文件并退出：
    ```:wq 保存并退出编辑器```
3. 如果当前编辑的文本还没有明确指定路径和文件名，或者需要将当前编辑的文本另存，这时可以在保存退出命令后加上文件名：
   ```:wq filename 保存退出时，将文件保存到参数filename指定的文件中```

4. 如果需要强制退出编辑器，可以使用如下命令:
   ```:q! 强制退出并不保存```
    需要注意的是强制退出将会丢失已经编辑的内容，因此在使用强制退出命令之前，应该确保没有保存的内容已经没有任何价值。



##### 11.2.4 Vim编辑器的模式
Vim编辑器有3种基本模式，分别是命令模式、插入模式和末行模式。
- 命令模式：可以使用方向键、编辑键等实现移动当前光标位置、翻页等功能。使用几个简单快捷键操作还可以删除单词、行。
- 插入模式：主要功能是编辑文本内容，使用方向键、编辑键移动当前光标位置、从键盘输入新的内容，也可以更改文本的内容等。
- 末行模式：可以输入一些命令，来实现存储文件、读取文件和退出编辑器等。

Vim启动后会直接进入命令模式，在命令模式种输入命令的前缀(这些前缀可能是":"、"/"等)，就可以进入末行模式。命令执行完成将直接退出末行模式，并返回命令模式。由于末行模式通常只在输入命令时存在，因此人们通常将其归入命令模式。

要进入插入模式，可以在命令模式下按i键。按Esc键退出并返回命令模式。

##### 11.2.5 Vim编辑器的工作界面



#### 11.3 向Vim编辑器迈出第1步

##### 11.3.1 读取文件

1. 打开新文件a2
    ```:e /root/a2```
    使用以上命令时，应该保证编辑器中的内容已经保存。如果没有保存，使用e命令将会提示错误。
2. 不需要保存当前文件，强制打开新文件，可以使用如下命令：
    ```:e! /root/a2```
3. 要从另一个文件读取文本，并添加到当前文本的最后，可以使用命令r。
    ```:r /root/a2 读取文件a2的内容，并追加到当前编辑文本的最后```


##### 11.3.2 保存文件

1. 保存当前已经编辑的文本：
    ```:w```
2. 如果当前正在编辑的文件还没有命名，或者需要将当前文件另存到另一位置，可以在命令w后面加上路径和名称：
    ```:w /root/a2 将当前文件存放到目录/file中，并命名为a2```

##### 11.3.3 进入插入模式并插入文本
使用Vim编辑器新建一个文件a3：
```vim a3```

1. 要输入内容，还需要进入插入模式。进入插入模式除了使用快捷键i之外，还可以使用以下快捷键：
- a:
- A:
- o:
- O:

2. 按i键，进入Vim编辑器的插入模式，就可以自由输入文本了。

##### 11.3.4 移动光标
除了使用键盘上的方向键移动光标外，还可以使用以下快捷键移动光标：
- k:向上移动光标
- j:向下移动光标
- h:向左移动光标
- l:向右移动光标

##### 11.3.5 删除文本
1. 删除单个字符
    在插入模式中，可以使用Back Space退格键和Delete键删除当前光标的前一个字符或当前字符。除此之外，还可以在命令模式中使用快捷键x删除单个字符。

2. 删除多个字符
- dd:删除当前光标所在行
- dw:删除当前光标处的单词，包括词尾空格
- de:删除当前光标处的单词
- d^:删除当前光标到行首的所有字符
- d$:删除当前光标到行尾的所有字符
- J:将当前光标所在行和下一行合并(相当于删除行尾的换行符)。

##### 11.3.6 撤销和恢复
如果在图形界面撤销操作可使用快捷键Ctrl+Z，在Vim的命令模式中，也可以使用以下快捷键执行撤销操作：
- u:撤销上一步操作，可以多次使用
- Ctrl+r:恢复已经撤销的操作，可多次使用

#### 11.4 快速移动光标

##### 11.4.1 按单词移动光标
1. 在命令行模式中，使用快捷键b，可以将光标快速移动到当前光标篇=所在单词的前一个单词的首字母。如果要移动到当前光标所在位置的前3个单词的首字母处，可以使用3b。
2. 如果要将光标移动快速移动到当前光标的后一个单词的首字母，可以在命令行模式中使用w。
3. 如果要移动光标至后一个单词的尾字母，可以使用快捷键e。
4. 如果要移动光标至前一个单词的的尾字母，可以使用快捷键ge。


##### 11.4.2 快速移动光标至行首和行尾




##### 11.4.3 移动光标至指定的行

如果快速定位到指定行，并执行编辑操作。
1. 为了方便查看行号，Vim编辑器提供了显示文本行号的功能，但默认情况下这个功能并没有启用，需要手动设置。
    要设置显示行号，可以在命令模式中执行：
    ```:set number```
2. 查看到了行号之后，就可以命令模式中，使用快捷键快速跳转到指定位置。
- gg:跳转到文本的第1行，也可以使用1G
- G:跳转到文本最后一行
- nG:跳转到第n行
3. 如果不需要使用行号，可以在命令模式中使用以下命令取消行号：
   ```:set nonumber```

##### 11.4.4 滚动屏幕
如果文本文件超过屏幕长度，图形界面中的文本编辑器通常会在窗口右侧显示一个滚动条，以便使用者滚动屏幕。但Vim编辑器没有滚动条，这时可以使用快捷键来完成这个功能。
- Page Up:向前翻页
- Page Down: 向后翻页
- Ctrl+B:向前翻页
- Ctrl+F:向后翻页
- Ctrl+U：向前翻半页
- Ctrl+D:向后翻半页

在插入模式中，不能使用快捷方式翻页，但可以使用编辑功能键Page Up、Page Down实现翻页。


##### 11.4.5 使用鼠标移动光标
Vim编辑器也提供了鼠标支持，要使Vim编辑器支持鼠标，可以使用以下命令：
```:set mouse=a```

##### 11.4.6 其他移动光标的技巧

1. 快速跳转到编辑位置
2. 搜索字符并移动光标
3. 以括号为目标移动光标


#### 11.5 Vim编辑器的查找和替换功能

##### 11.5.1 简单的查找功能

**命令格式**
```/pattern```

例如使用命令/home查找字符串home，Vim编辑器会从当前光标位置开始向下查找，并将光标移动到查找到的字符串的第1个字符处。

- n:跳转到下一个字符串
- N:跳转到上一个字符串


##### 11.5.2 反向查找
从当前位置开始向上查找，基本格式如下：
```?pattern```
- n:跳转到上一个字符串
- N:跳转到下一个字符串


##### 11.5.3 查找时忽略大小写
1. 要让编辑器查找时忽略字符串的大小写，可以使用以下命令：
    ```:set ignorecase```
2. 关闭忽略大小写功能：
    ```:set noignorecase```


##### 11.5.4 高亮显示查找结果

1. 要高亮显示所有匹配的结果：
    ```:set hlsearch```
2. 关闭搜索结果高亮显示功能：
    ```:set nohlsearch```

##### 11.5.5 增量查找
**增量查找：**指用户输入需要查找的字符串的同时，编辑器按用户的输入同步进行查找。

1. 打开编辑器的增量查找功能，可以在命令模式中执行以下命令：
    ```:set incsearch```
2. 开启增量查找功能之后，输入查找命令"/ho"：
    用户输入查找字符串的同时，编辑器也开始了查找工作(之前是用户输入命令并按Enter键后才开始查找)。
3. 关闭增量查找功能：
   ```:set noincsearch```
##### 11.5.6 简单的查找替换功能
仅能替换光标所在行找到的第1个字符串
**命令格式**
```:s/pattern1/pattern2/```
将光标所在行的第1个pattern1替换为pattern2。

- pattern1:要查找的文本
- pattern2:替换后的文本
- /:分隔符，s并未强行规定使用"/"，也可以使用":"


##### 11.5.7 区域性查找替换
1. 如果要替换当前行中找到的所有字符串(即全行替换)，可以使用标记g:
    ```:s/the/The/g```
2. 也可以指定一个要替换的范围。
   ```:1,10s/the/The/g 替换第1行至第10行的所有内容```

3. 替换某一行至最后一行的所有字符串：
    ```:5,$s/the/The/g 替换第5行至最后一行的所有字符串```
4. 使用"+"、"-"表示一个模糊的范围。
    ```:+10,$-10s/the/The/g```
5. 替换所有字符串：
   ```:%s/the/The/g```


##### 11.5.8 谨慎的查找替换
谨慎的查找替换时，需要使用标记c。
```:%s/the/The/gc```
执行上面的命令后，Vim会高亮显示找到的字符串，并询问用户如何处理找到的字符串。提供几个选项：
- y:直接输入y执行替换，继续查找字符串
- n:直接输入n跳过当前找到的字符串，继续查找字符串
- a:替换所有找到的字符串，并且不询问
- q:不执行替换并退出替换模式
- l:执行替换并退出替换模式
- Ctrl+E:向上滚屏一行
- Ctrl+Y：向下滚屏一行



#### 11.6 Vim编辑器中的窗口操作

##### 11.6.1 分割窗口


1. 分割当前窗口(上下分割)
    ```:split```
2. 垂直分割(左右分割)
   ```:vsplit```
3. 分割窗口并打开空白文本
   ```:new```
4. 分割窗口并打开新文件
    ```:new /etc/ssh/sshd_config```
5. 打开文件时分割窗口
   ```vim -o /etc/samba/smb.conf  /etc/ssh/ssh_config  /etc/ssh/ssh_config Vim启动后会在3个窗口打开不同的文件```

##### 11.6.2 关闭窗口
1. 如果关闭光标所在窗口，可以使用命令:close
2. 如果光标不在需要关闭的窗口中，可以使用快捷键Ctrl+W
3. 如果需要关闭除当前窗口之外的其他窗口，可以在当前窗口的命令模式中使用命令"only"


##### 11.6.3 控制窗口大小

1. 分割窗口时加上窗口大小参数：:6split 、:6vsplit、:6new......
    
2. 如果要将当前光标所在窗口放大，可以使用快捷键Ctrl+W++(即Ctrl+W+Shift+=)。
3. 如果要缩小窗口，可以使用快捷键Ctrl+W+-。

##### 11.6.4 窗口中的操作


1. 切换窗口
- Ctrl+W k:将光标移动到上面的窗口中(先按下Ctrl键和w键，然后松开Ctrl和w键，最后再按下k键)
- Ctrl+w j:将光标移动到下面的窗口中
- Ctrl+W h:将光标移动到左边的窗口中
- Ctrl+W l:将光标移动到右边的窗口中
- Ctrl+W t:将光标移动到顶部的窗口中
- Ctrl+W b:将光标移动到底部的窗口中


2. 在众多窗口中退出
- qall:关闭所有窗口，如果有的窗口中的修改还没有保存，窗口将不会关闭，对于这类窗口，用户可以单独保存或退出。
- wall:保存所有修改过的窗口
- wqall:保存并退出所有窗口
- qall!:不保存未修改的内容，强制关闭所有窗口，并退出Vim



##### 11.6.5 移动窗口
- Ctrl+W K:将当前光标所在窗口向上移动
- Ctrl+w J:将当前光标所在窗口向下移动
- Ctrl+W H:将当前光标所在窗口向左移动
- Ctrl+W L:将当前光标所在窗口向右移动

需要注意K、J、H、L键都是大写。

#### 11.7 Vim编辑器的高级技巧

##### 11.7.1 复制和粘贴
Vim的命令模式也提供了几个复制、粘贴操作的快捷键：
- yy:复制光标所在的行至缓冲区内
- nyy:复制n行至缓冲区内
- y^:复制当前光标所在位置到行首的内容至缓冲区内
- y$:复制当前光标所在位置至行尾的内容至缓冲区内

复制后，只需要将光标移动到需要粘贴的位置，按下p键即可粘贴复制的文本。

##### 11.7.2 剪切和粘贴

1. 移动文本时，首先需要使用dd或d快捷键将需要移动的文本删除，Vim会在删除之后将删除的文本放入缓冲区内。
2. 执行删除之后，将光标移动到需要粘贴的位置，然后使用p键粘贴文本。
3. 执行p键后，编辑器会将缓冲区中的内容粘贴到当前光标之后(如果使用dd快捷键删除，则粘贴至下一行)。

粘贴文本除了使用p键之外，还可以使用P键(大写字母)，其功能是将缓冲区中的文本粘贴到当前光标之前。

##### 11.7.3 编辑多个文件
Vim编辑器也提供了同时编辑多个文件的功能。

1. 同时编辑多个文件：
    ```vim a1 a2 a3 ```
    虽然可以打开多个文件，但同一时间用户只能编辑一个文件。默认将文件a1放置在前台供用户编辑，
2. 查看打开的文件列表：
   ```:args```
3. 在打开的多个文件之间切换，首先应该确保当前处于前台的文件已经保存：
- next:
- prev:
- prev!：
- first:
- last:
- last!：
- Ctrl+6:


##### 11.7.4 Visual模式

1. 使用Visual模式自由选择文本
    使用Visual模式自由选择字符时，需要在命令模式中将光标移动到选择字符的起始位置，然后按下v键进入Visual模式。在Visual模式中，可以使用移动光标的快捷键选择文本。

2. 使用Visual模式选择多行
    在Visual模式中，可以使用上、下方向键或j、k键选择文本行。
3. 使用Visual模式选择矩形区域
    将光标移动到矩形区域的左上角的顶点，然后按下快捷键Ctrl+V进入Visual模式。使用方向键移动光标即可选择一个矩形区域。
    如果要修改文本的起始位置，可以使用快捷键o切换至起始位置重新选择。

##### 11.7.5 在Vim编辑器中执行Shell命令
不懂





#### 11.8 定制Vim编辑器及灾难恢复

##### 11.8.1 定制文件vimrc
有些用户可能希望Vim编辑器一启用就能展示自己经常使用的功能，例如显示行号、搜索结果高亮等功能，这时需要定制Vim编辑器。

**Vim编辑器的定制文件**
定制Vim编辑器主要是通过修改定制文件的方法来实现的。Vim编辑器使用的定制文件名称为.vimrc，但该文件在不同的系统中位置和名称可能会不同。

在Linux系统中，定制文件的路径及名称通常为$HOME/.vimrc。如果无法找到定制文件，可以使用以下命令查看帮助：
```:help vimrc```

##### 11.8.2 定制Vim编辑器
定制文件的内容主要是常用的命令，包括搜索结果高亮、增量查找、显示行号、设置快捷键及语法检查。在定制文件中使用命令时，不需要在命令前使用":"，直接输入要使用的命令即可。

```cat ~/.vimrc```
```set number
    set hlsearch
    set incsearch=100
```
##### 11.8.3 灾难恢复


使用Vim编辑文本文件时，会自动建立一个交换文件，名称为.filename.swp。这是一个隐藏文件，其中的filename为编辑的文件名称。每过一段时间，Vim会自动将更改的内容保存到交换文件中。Vim编辑器正常退出时，会删除这个交换文件，如果是非正常退出时，这个文件就留在了文件系统上，此时可以利用交换文件进行灾难恢复。

1. 恢复文件a
    ```vim -r a 使用选项r恢复文件a的内容```
2. 指定交换文件恢复文件：
    ```# vim -r .a.swp```
3. 未完待续