### 9 数据备份和应用程序管理


#### 9.1 数据备份基础
##### 9.1.1 数据备份概述
1. 数据丢失的原因
2. 如何避免数据丢失
   
##### 9.1.2 备份数据存放的介质

##### 9.1.3 备份类型
##### 9.1.4 备份时间选择



#### 9.2 tar备份工具
几乎所有的Linux发行版都安装了基本的数据备份工具，虽然这些工具只是一些最基本的工具，但其功能仍十分强大，足以应付多数数据备份任务。
最常使用的工具是归档工具tar。
##### 9.2.1 tar命令的基本格式
tar是UNIX和Linux系统中的打包工具，可以将多个文件或目录打包(也称为归档)成一个文件，

**命令格式**
```tar [option] [file]...```

**常用选项**
- c:建立一个新归档文件
- f:指定需要归档的文件
- t:列出指定文件的内容
- v:以详细模式显示命令执行过程
- x:从归档文件中还原文件
- z:通过gzip处理归档的文件
- j:通过bzip2处理归档的文件
  
##### 9.2.2 tar归档和备份文件
tar命令的功能是将多个文件及目录归档为一个文件，因此也可以使用这个命令对文件和目录进行备份。

**归档文件格式**
```tar -cf filename directory ```

1. 例如要归档root用户的家目录
    ```# tar -cf root.tar root 使用选项c和f归档root目录，并将归档文件命名为root.tar，假定当前工作目录为根目录/```
    在根目录中使用此命令就可以备份root用户的家目录。
2. 执行命令时，tar会占用终端，此时可以在命令后加上&，将命令放到后台执行：
    ```# tar -cf root.tar root & 使用&将命令放在后台执行```

3. 也可以使用选项v，显示归档时的详细信息：
   ```# tar -vcf root.ta root 使用选项v显示归档详细信息```
4. 在归档文件时，有时可能希望在归档文件的同时压缩的文件，这样就可以节省存储空间。
    ```# tar -zvcf root.tar.gz root 使用选项z，用gzip压缩归档的文件```
5. 如果在归档文件时，需要使用bzip2压缩归档文件，可以配合使用选项j。例如归档root的家目录，并使用bzip2压缩归档文件：
    ```# tar -jvcf root.tar.bz2 root 使用选项j，用bzip2压缩归档的文件```
##### 9.2.3 查看归档文件中的文件列表
1. 例如查看归档文件root.tar内的文件列表：
    ```# tar -tf root.tar 使用选项t查看归档文件内的文件列表```
2. 如果要查看的归档文件使用了gzip压缩，应该同时配合使用选项z。查看归档文件root.tar.gz内的文件列表：
   ```# tar -tzf root.tar.gz 使用选项z和t查看gzip压缩的归档文件```
3. 查看使用bzip2压缩的归档文件时，应该同时配合使用选项j。例如查看归档文件root.tar.bz内的文件列表：
   ```# tar -tjf root.tar.bz```

##### 9.2.4 从归档文件中还原文件

1. 将归档文件root.tar中的文件还原到当前目录下：
    ```# tar -xf root.tar 使用选项x还原归档文件```
2. 如果需要在还原归档文件时，查看命令执行过程，可以加上选项v:
    ```# tar -vxf root.tar 使用选项v显示执行过程```
3. 还原使用gzip压缩的归档文件时，需要配合使用选项z。例如将归档文件root.tar.gz还原到当前目录：
   ```# tar -zxvf root.tar.gz 使用选项z还原使用gzip压缩的归档文件```
4. 如果要还原使用bzip2压缩的归档文件，则需要配合使用选项j。例如将归档文件root.tar.bz2还原到当前目录：
   ```# tar -jxvf root.tar.bz2```

#### 9.3 cpio备份命令
cpio是一个比较古老的备份命令，也是用于磁带机备份的工具。

##### 9.3.1 cpio命令的基本格式
cpio命令与tar命令一样，其功能也是将文件或文件列表归档到文件中。

**命令格式**
```# cpio [option] [destination-directory]```

**常用选项**
- i:使用copy-in模式，还原归档文件或列归档文件中的文件列表。
- o:使用copy-out模式，建立归档文件。
- p:使用copy-pass模式，将文件直接复制到目的目录。
- c:使用老式的ASCII归档格式。如果需要跨平台使用，应该使用老式的ASCII归档格式。
- d:创建需要的目录。如果需要文件不处于同一目录中，应该使用此选项。
- v:显示处理过程的详细信息。
- t:显示归档文件中的文件列表。
- m:保持文件的时间戳记。
- H:使用指定的格式归档文件。

**参数说明**
- copy-in:
- copy-out:
- copy-pass:

##### 9.3.2 使用cpio归档文件

1. 由于cpio命令不会操作文件，因此输入、输出都必须要借助重定向或管道来完成。
    ```# find -print | cpio -o >../backup.cpio 使用find命令输出当前目录中的所有文件，使用选项0备份管道传过来的所有文件，并保存到上级目录中```
2. 直接使用cpio命令归档文件过程中，不会有任何提示信息。如果需要显示归档的文件，可以使用选项v:
    ```# find -print | cpio -ov >../backup.cpio使用选项v显示归档文件的详细信息```
3. 如果重定向的目标是一个设备，cpio会归档文件存放到设备上。例如将归档文件存放到磁带机设备：
    ```# find -print | cpio -ov >/dev/st0 使用重定向将归档文件存放到磁带机设备```
4. cpio并没有提供压缩功能，如果要压缩生成的归档文件，可以通过管道和相应的压缩命令。
   ```# find -print | cpio -ov | gzip >../backup.cpio.gz```
5. 也可以使用bzip2压缩生成的归档文件：
   ```# find -print | cpio -ov | bzip2 >../backup.cpio.bz2```

##### 9.3.3 查看归档文件中的文件列表

1. 如果要查看归档文件中的文件列表，可以使用选项t:
   ```# cpio -t <backup.cpio```
2. 查看归档文件中的文件列表时，也可以使用选项v，查看更详细的文件信息：
    ```# cpio -tv <backup.cpio```
3. 查看归档文件中的文件列表时：
   ```# cpio -tv "*.c" <backup.cpio```

##### 9.3.4 恢复cpio归档文件
1. 如果归档文件使用了不同的格式，cpio会自动判断并恢复文件，无须再指定归档文件的格式。
   ```# cpio -i <../backup.cpio 使用选项i，将文件恢复到当前目录```
   
未完待续

#### 9.4 压缩工具和整盘备份工具dd

##### 9.4.1 使用gzip压缩文件

**命令格式**
```gzip [option] filename```

**常用选项**
- c:压缩后将结果输出到标准输出(用户所使用的终端)，并保留原始文件
- d:解压缩文件
- l:显示压缩文件的详细信息
- r:递归地处理目录下的所有文件及子目录，或递归地解压缩文件内的目录和子目录
- v:显示命令的执行过程
- t:测试压缩文件


1. 使用gzip命令压缩时，可以不使用任何选项。
    ```# gzip test.tar 压缩当前目录中的文件test.tar```
    将test.tar文件压缩后输出为一个新文件，压缩后的新文件名为原文件名结尾加上.gz
    需要注意的是使用以上方式压缩完成之后，命令将会自动删除原文件。
2. 如果需要保留原文件，应该使用选项c，还要使用重定向的方式保存压缩后的文件：
    ```# gzip -c9 test.tar >test.tar.gz 使用选项c保留原文件，9表示压缩率，由于使用选项c会将压缩结果输出到标准输出，因此需要使用重定向方式保存压缩结果```
    由于压缩率越大，计算量越大，因此如果原文件过大，上面这个示例命令会导致命令执行时间过长。
3. 使用选项r递归地压缩目录中的所有文件：
    ```# gzip -r test```
4. 有时需要测试一个压缩文件是否正确，可以配合使用选项t。
   ```# gzip -t test.tar.gz```
    如果压缩文件中没有任何错误，命令将不会返回任何结果。
5. 如果要显示压缩文件的详细信息，可以使用选项l:
    ```# gzip -l test.tar.gz 使用选项l查看压缩文件的详细信息```
6. 解压缩使用gzip压缩的文件时，需要配合使用选项d。
   ```# gzip -dv test.tar.gz```
    使用gzip压缩时，无法对多个文件执行归档。因此如果要压缩的是多个文件或目录，应该先使用归档命令将文件归档。

##### 9.4.2 使用bzip2压缩文件
bzip2的压缩效率更高，但速度相对较慢。

**命令格式**
```bzip2 [option] filename```

**常用选项**
- k:压缩、解压缩完成之后，保留原始文件
- d:执行解压缩任务
- t:测试压缩文件的完整性
- num:num为数字1~9，表示压缩率级别。其中1表示压缩率最低、速度最快，9表示压缩率最高、速度最慢。
- v:执行时显示执行的详细信息

1. 可以不使用任何选项压缩文件：
    ```# bzip2 test.tar 解压缩文件test.tar```
2. 使用选项k，让bzip2压缩任务后不删除原始文件：
    ```# bzip2 -k test.tar```
3. 指定压缩率：
   ```# bzip2 -k9 test.tar```
4. 测试压缩文件：
    ```# bzip2 -t test.tar.bz2 使用选项t测试文件test.tar.bz2的完整性```
5. 解压缩文件显示详细信息：
    ```# bzip2 -dvk test.tar.bz2 使用选项d和v解压缩文件并显示详细信息```
##### 9.4.3 整盘备份命令dd
dd是一个非常特殊的命令，其作用是从标准输入或文件中读取数据，并按指定的格式转换数据，然后输出。

**命令格式**
```dd <OPTION>```
dd命令不需要使用参数，所有参数都通过选项指定。

**常用选项**
- if:指定要读取的文件，默认为标准输入
- of:指定要输出的文件，默认为标准输出
- ibs:指定读取数据时的块大小，默认为512字节
- obs:指定输出数据时的块大小，默认为512字节
- bs:将读取、输出时的块大小一起指定
- count:指定读取的区块数

1. 备份磁盘sda:
    ```# dd if=/dev/sda of=/mnt/backup/backup_sda.dd 使用dd命令将磁盘sda备份到文件/mny/backup/backup_sda.dd中```
2. 恢复磁盘，只需将其读写和写入的文件进行调换即可。例如要将从/dev/sda中备份的数据恢复到一个新的设备sda中：
   ```# dd if=/dev/sda of=/dev/sdb ```

3. 许多时候可能希望能够在备份磁盘分区的同时，压缩备份数据以节省空间，这时可以与gzip等压缩命令一起使用。
    ```# dd if=/dev/sda | gzip >/mnt/backup/backup_sda.dd.gz 将备份数据通过管道传送给gzip命令压缩```
    命令dd首先从磁盘sda中读取数据，并将这次数据通过管道交给第2个命令gzip。gzip将这些数据压缩之后，通过重定向的方式写入文件backup_sda.gz中

4. 如果要将使用gzip压缩后的数据恢复到磁盘sdb中，可以反向使用以上命令：
   ```# gzip -dc /mnt/backup/backup_sda.dd.gz | dd of=/dev/sdb ```

未完待续


#### 9.5 RPM包管理命令rpm


##### 9.5.1 RPM包管理器简介
Linux系统诞生早期，用户安装应用程序需要自行手动编译(编译是利用程序代码生成可执行文件的过程)。手动编译软件虽然有一定优势，但存在安装时间长且需要用户有一定的专业基础等缺点。因此许多发行版推出了软件包管理器，其中以RPM包管理器最为著名，除此之外还有Debian使用的dpkg等。




##### 9.5.2 rpm命令基本格式

在Linux系统中，使用命令rpm调用RPM包管理器。
**命令格式**
```rpm [OPTION...]```

**常用选项**
- q:使用查询模式
- a:查询所有软件包
- i:显示详细信息，如果指定了软件包，则安装软件包
- l:显示软件包的文件列表
- p:查询指定的软件包
- f:查询指定文件所属软件包
- v:显示命令执行过程
- h:安装软件包时显示进度信息
- e:卸载软件包时显示进度信息
- U:升级软件包
- force:长格式选项，强制操作，忽略操作过程中的冲突。
- nodeps:长格式选项，忽略操作过程中的软件依赖性，强制操作。此参数可能会导致软件无法使用，应该慎重。
- oldpackage:忽略冲突，强制升级软件包

##### 9.5.3 使用rpm命令查询软件包

1. 查询已安装的软件
   许多时候需要查询系统中已经安装的软件包，例如验证系统中某个软件包版本是否正确、系统中是否已安装某个软件包等。
    (1) 例如要查询系统中是否装有一个名为samba-client的软件包：
    ```# rpm -q samba-client 使用选项q和软件包名称，查询系统中是否安装有指定的软件包```

    (2) 查询系统上已经安装的所有软件包：
    ```# rpm -qa 使用选项q和a显示系统中已经安装的软件包```

    (3) 使用模糊查询软件包
    ```# rpm -qa | grep ssh 使用管道和grep命令模糊查询软件包```

    (4) 显示指定软件包的详细信息
    ```# rpm -qi chkconfig 使用选项i显示软件包的概况```
2. 查询软件包中的文件
    (1) 查看软件包chkconfig中包含的详细文件列表：
    ```# rpm -ql chkconfig 使用选项q和l查看软件包含的文件列表```

    (2) 如果要查看文件列表的不是一个已经安装的软件包，而是一个软件包的安装文件，这时可以使用选项p指定输入的参数为一个软件包文件。
    ```# rpm -qpl samba-client-3.0.33-3.7.e15.i386.rpm 指定参数为一个软件包```
    (3) 也可以使用选项p和i查看软件包的概况：
    ```# rpm -qpi samba-client-3.0.33-3.7.e15.i386.rpm ```
    (4) 反向查询一个文件对应的软件包，防止有时无意中删除了一个文件，需要知道应该重新安装的软件包的名称。
    ```# rpm -qf /bin/ls 使用选项f指定查询/bin/ls所属的软件包，使用选项f应该输入文件绝对路径```



##### 9.5.4 使用rpm命令安装软件包
rpm命令最大的功能是安装软件包，软件包可以从原系统的安装光盘中获取，也可以从互联网上下载。

**获取软件包**
- RHEL5.3的光盘中自带的软件包，通常位于光盘根目录的Server子目录中。
- 从互联网上软件的官方网站下载软件包


1. 在安装光盘中模糊查找软件包：
    ```# ls /media/Server/ | grep ssh 使用ls和grep命令查找名称中包含ssh的软件包```

    **安装软件包示例**
    (1) 例如需要安装一个软件包：
    ```# rpm -i cabextract-1.3-1.i386.rpm 使用选项i安装，用户将不会得到任何提示信息，安装好之后会直接返回命令提示符界面```

    (2) 如果需要显示安装过程中的详细信息，可以加上选项v和h。
    ```# rpm -ivh cabextract-1.3-1.i386.rpm 会输出安装进度等信息```

    (3) 许多安装包会遇到依赖性问题，即在安装应用程序之前，应该先安装能让该应用程序正常工作的前提软件包。
    例如要安装gcc编译器，需要先安装glibc-devel 和libgomp。可同时安装。

    (4) 有时管理员可能需要忽略软件包的依赖性，强制安装软件包。可使用选项nodes忽略软件的依赖性，适用于依赖性错误的情况，例如有些软件包可能会依赖软件包本身。一般不建议使用。
    ```# rpm -ivh --force --nodeps samba-client-3.0.33-3.7.e15.i386.rpm```

##### 9.5.5 使用rpm命令卸载软件包
1. 如果知道需要卸载的软件包名称，直接使用选项e卸载：
    ```# rpm -e samba-client ```
2. 卸载软件时可能也会出现依赖性问题，如卸载的软件包被另一个软件包所依赖，如果确定不再使用这些软件包，可以按照其依赖性提示，将这些依赖的软件包一一卸载，也可以使用选项e同时卸载多个依赖的软件包。

##### 9.5.6 使用rpm命令升级软件包

1. 例如使用选项U升级软件包：
    ```# rpm -Uvh bzip2-libs-1.0.3-4.e15_2.i386.rpm```
2. 由于系统中安装有低版本的软件，因此在安装过程中可能会出现冲突，导致升级失败，此时可以使用选项oldpackage强制升级软件包：
   ```# rpm -Uvh --oldpackage bzip2-libs-1.0.3-4.e15_2.i386.rpm ```

#### 9.6 编译安装相关命令和工具
Linux系统诞生早期，许多应用程序都是通过编译安装的。虽然使用编译安装方式比较费时，但也存在许多优点。

- 可以获得更新的软件
- 编译安装的软件可以按需要定制。编译安装时，可以通过开启、禁用某些功能获得更好的性能。
- 编译安装的软件会按系统硬件的实际编译某些模块，因此有更好的适用性。
- 高级用户可以按需要修改源代码，为自己量身定制软件。


##### 9.6.1 安装编译环境
在编译安装应用之前，首先需要安装编译环境。Linux系统中的大多数软件使用的编译环境都是gcc，因此应该先安装gcc编译环境。

1. 可以使用rpm命令检测系统是否已经安装了gcc编译环境：
    ```# rpm -qa | grep gcc```
    如果没有安装编译环境，可以挂载光驱，然后在光驱的安装包目录中使用以下命令(可能还需安装其它软件或编译环境)：
    ```# rpm -ivh gcc-4.1.2-44.e15.i386.rpm ..........```
2. 安装图形界面中的软件时，需要安装gtk+编译环境。可以在光盘的安装程序目录中安装gtk+软件包：
    ```# rpm -ivh ..........(依赖关系比较复杂，需要安装很多东西)```

##### 9.6.2 获取软件工具wget、links


1. 使用wget工具下载软件

**命令格式**
```wget [option] <URL>```

**常用选项**
- c:续传上次没有下载完成的任务，前提条件是当前工作目录中保存有上次没有下载完成的文件。

(1) 下载源码：
    ```# wget http://www.mplayerhq.hu/MPlayer/releases/MPlayer-1.0rc4.tar.bz2 将下载的文件保存在当前目录中```
(2) 如果下载过程中被中断，可以使用选项c续传未完成的任务：
    ```# wget -c http://www.mplayerhq.hu/MPlayer/releases/MPlayer-1.0rc4.tar.bz2 只能在包含未完成任务文件的目录中执行，且需要目标网站支持续传功能```

2. 字符界面中的浏览器links
   ```# links http://www.mplayerhq.hu 使用link浏览器打开指定的网站```

##### 9.6.3 编译前的配置
在编译安装之前，应该先执行配置工作。配置工作需要使用软件源码目录中自带的可执行文件configure。

**注意：**开始安装软件前，应该先查看软件源码中的说明文件(通常其名称为README)。说明文件中可能会列出需要安装的前提软件、编译时需要注意的事项(例如有些软件不允许并行编译)等。

1. 下载的源码包通常都会使用tar工具归档：首先需要从下载的归档文件中恢复源码目录：
    ```# tar -jxvf MPlayer-1.0rc4.tar.bz2 使用tar命令恢复下载的归档文件包```
    tar命令将恢复的文件放到当前目录中的MPlayer-1.0cr4子目录中。
2. 恢复归档文件后，就可以进入源代码目录，查看配置的帮助信息：
    ```# cd MPlayer-1.0cr4```
    ```# ./configure --help 执行源代码目录中的configure，并使用help选项查看帮助```
3. 如果不使用prefix指定程序的安装目录，程序会使用/usr/local作为其安装目录。用户可以指定选项prefix的值自定义应用程序的安装目录。
   ```# mkdir -p /usr/local/MPlayer 由于配置文件不会自动生成目录，因此需要手动生成安装目录```
   ```# ./configure --prefix=/usr/local/MPlayer```
   这个命令会产生大量的输出，而且非常耗时。用户可以从命令输出中，了解配置命令configure检测的系统项。

##### 9.6.4 编译软件命令make
使用可执行文件configure完成配置工作后，就需要使用命令make对软件执行编译了。

在软件的源代码目录中对应用程序执行编译：
```# make ```

通常这个过程消耗的时间比configure命令消耗的时间要长得多，并且会产生许多输出。

如果在软件编译过程中出现错误，可能需要查阅相关说明文档并重新配置，然后再编译。

##### 9.6.5 安装命令make install
编译成功后，就可以使用命令make install安装应用程序了。在安装过程中，make install会使用选项prefix指定的目录，将应用程序的库文件、可执行文件、帮助文档等安装到指定的目录中。
1. 在本例中可以直接使用make install安装软件：
   ```# make install ```
2. 为了运行图形化的MPlayer，还需为其安装默认的皮肤。
   ```# wget http://www3.mplayerhq.hu/MPlayer/skins/Blue-1.7.tar.bz2```

    下载完成后，将其解压缩：
    ```# tar -jxvf Blue-1.7.tar.bz2```

    将皮肤文件复制到软件包的皮肤目录并重命名：
    ```# cp -r Blue /usr/local/MPlayer/sgare/mplayer/skins/default```
##### 9.6.6 运行及环境配置

1. 运行软件
    软件被安装在了目录/usr/local/MPlayer中，可以首先查看该目录下的文件：
    ```# ls -l /usr/local/MPlayer/```

    (1) 由于软件的相关设置没有写入环境变量，因此需要使用绝对路径的方式运行软件：
    ```# /usr/local/MPlayer/bin/mplayer5.mps 如果没有使用prefix选项自定义安装目录，可以直接使用命令mplayer，不必加上全路径```

2. 环境配置
   安装的软件不能像运行其他软件和命令那样，直接输入命令运行。均使用了绝对路径的方式运行软件，这是因为新安装的软件使用了自定义路径(如果没有自定义软件的安装目录，可跳过环境配置步骤)，这个路径并不在系统环境变量PATH中，为了可以更快捷地运行软件，还需要配置环境变量。
  
   (1) 在命令行中配置环境变量，可以使用如下命令：
   ```# PATH=$PATH:/usr/local/MPlayer/bin 将MPlayer的程序目录保存到环境变量PATH```
   ```# export PATH 使用export 将PATH变量定义为全局变量```

    (2) 但使用上面的方法将会在系统重新启动后失效。如果需要使其在重启后仍然有效，可以使用修改系统配置文件的方法。
    将环境变量保存到配置文件中时，如果仅需要为当前用户添加环境支持，可以将相关配置语句写入文件~/.bash_profile中：
    (比较复杂，待续)
    ```# eho "# add MPlayer directory">>~/.bash_profile  ```  

##### 9.6.7 卸载软件命令make
使用编译安装的软件通常可以使用make install命令卸载，此命令只能在软件源码目录中使用：
```# make uninstall ```

以上命令需要源码目录中的相关文件支持(主要是源码目录中的Makefile等文件)，如果文件不支持，就无法使用以上命令卸载软件。

对于不能使用make uninstall命令卸载的软件，如果使用了自定义软件安装路径的方式安装软件，只需将环境配置、安装目录及其中的所有文件删除即可。如果使用默认路径，则不能删除(可能会删除掉其他软件或相关帮助信息等)。

#### 9.7 利用yum工具安装应用程序

##### 9.7.1 yum简介

##### 9.7.2 配置yum


1. yum的配置文件
    yum使用的配置文件为/etc/yum.conf，这个文件是yum工作的核心配置文件。查看配置文件的内容如下：
    ```# cat /etc/yum.conf ```



##### 9.7.3 查询源上的软件包
使用yum安装软件包之前，可能需要查询源上的软件包，也可能因不记得软件包的具体名称而需要模糊查询。

**命令格式**
```yum search package_name```

1. 例如查询包含httpd的软件包：
    ```# yum search httpd```


##### 9.7.4 利用yum安装软件包

**命令格式**
```yum [-y] install soft_package_name ```

选项y会自动允许yum的所有操作而不提示用户。

1. 例如安装Web服务器程序
    ```# yum install httpd```

2. 如果确信使用的yum源可靠，可以使用选项y授权yum自动操作：
    ```# yum -y install httpd```

##### 9.7.5 利用yum卸载软件包

**命令格式**
```yum [-y] remove soft_package_name```


1. 例如使用yum删除软件包：
    ```# yum remove httpd```
2. 使用选项y授权yum自动操作：
     ```# yum -y remove httpd```

##### 9.7.6 安装、卸载软件包组

